---
title: "Random_Sequence_Plot"
author: "JY"
date: "03/09/2024"
output: html_document
---
```{r}
library(tidyverse)
library(ggtext)
#library(mgcv)
#library(broom)
library(cowplot)
library(viridis)
library(scales)
library(ggpattern)
library(RColorBrewer)
Sys.setenv(LANG = "en")
```

## Common plotting functions
**Update 2022-11-08** 
This list is used as a shared plotting set up.
```{r}
p.timecourse <- list(
  stat_summary(fun = "mean", geom = "point", size = 3),
  stat_summary(fun.data = "mean_cl_boot", geom = "errorbar", width = 3),
  stat_smooth(aes(size = Genotype == "WT"), method = "loess", 
              formula = 'y~x', se = FALSE),
  scale_x_continuous(breaks = seq(0,240,30)),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  labs(x = "Time (min)", y = "Cta1-GFP protein level (a.u.)"),
  theme_cowplot(line_size = 0.7, font_size = 14),
  theme(legend.position=c(0.02,0.9),
        #legend.direction = "horizontal",
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 3), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)

p2.timecourse <- list(
  stat_summary(fun = "mean", geom = "point", size = 3),
  stat_summary(fun.data = "mean_cl_boot", geom = "errorbar", width = 3),
  stat_smooth(aes(size = Genotype == "WT"), method = "loess", 
              formula = 'y~x', se = FALSE),
  scale_x_continuous(breaks = seq(0,240,30)),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  labs(x = "Time (min)", y = "Cta1-GFP protein level (a.u.)"),
  theme_cowplot(line_size = 0.7, font_size = 20),
  theme(legend.position=c(0.02,0.9),
        #legend.direction = "horizontal",
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 5), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(5)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(5)),
  )
)


mean.timecourse <- list(
  stat_summary(fun = "mean", geom = "point", size = 3),
  stat_smooth(aes(size = Genotype == "WT"), method = "loess", 
              formula = 'y~x', se = FALSE),
  scale_x_continuous(breaks = seq(0,240,30)),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  labs(x = "Time (min)", y = "Cta1-GFP protein level (a.u.)"),
  theme_cowplot(line_size = 0.7, font_size = 14),
  theme(legend.position=c(0.02,0.9),
        #legend.direction = "horizontal",
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 3), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)



scatter <- list(stat_summary(fun = "mean", geom = "point", size = 3),
                scale_y_continuous(breaks = seq(0,1.0,0.25)),
                scale_x_continuous(breaks = seq(0,1.0,0.25)),
                scale_size_manual(values = c(0.8, 1.5), guide = "none"),
                expand_limits(x = 0, y = 0),
                theme_cowplot(line_size = 0.7, font_size = 14),
                theme(legend.position=c(0.02,0.82),
                legend.text = element_text(face = 3), 
                legend.title = element_text(),
                axis.title = element_text(size = rel(1)), 
                axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1))))


bar.list <- list(
  stat_summary(fun.data = "mean_cl_boot", conf.int = .95, colour = "red", linewidth = 1, size = 0.8),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  labs(x =paste0("2mM H2O2, OL variants ", deparse1(substitute(input_tp)), " min"), y = "Cta1-GFP protein level (a.u.)"),
  theme_cowplot(line_size = 0.7, font_size = 14),
  theme(legend.position=c(0.02,0.9),
        #legend.direction = "horizontal",
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 3), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)

bar.list.no.stat <- list(
  #stat_summary(fun.data = "mean_cl_boot", conf.int = .95, colour = "red", linewidth = 1, size = 0.8),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  theme_cowplot(line_size = 0.7, font_size = 14),
  theme(legend.position=c(0.02,0.9),
        #legend.direction = "horizontal",
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 3), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)
  

```

## TF deletion mutants compared with wild type
### Prepare data
Import data
Beads were used to adjust for comparable voltage across days
```{r}
files <- dir("input/gz_merge", pattern = "merge-*") # get the file names of the merged
files <- file.path("input/gz_merge", files)         # this appends the directory to the file names

names(files) <- c("Rep1-0Pi-H2O2","Rep2-0Pi-H2O2","Rep3-0Pi-Ctrl","Rep4-H2O2-Ctrl")


tp <- c("0min",  "30min", "60min", "90min", "120min", "150min",  "180min", "210min", "240min") # ordered time points

# import and process the data to the format we want
dat.ord <- map_dfr(files, ~read_csv(., na = c("", "NA", "N/A"), col_types = cols()), .id = "Replicate") %>% 
  filter(Gate == "CTA1-GFP", `X Parameter` == "BL1-H", is.na(`Y Parameter`), Sample != "beads", Count > 100) %>% 
  select(Replicate, Plate, Group, Sample, Count, median = `X Median`, peak = `X Peak`,
         sd = `X SD`, cv = `X %CV`, rCV = `X %rCV`) %>% 
  mutate(Group = ordered(Group, levels = tp)) %>% 
  arrange(Group)

```

Subset the dataset and merge with the genotype information
```{r}
# get genotype info
tr_files <- dir("input/treatment", pattern = "d0*")
tr_files <- file.path("input/treatment", tr_files)
names(tr_files) <- c("Rep1-0Pi-H2O2","Rep2-0Pi-H2O2","Rep3-0Pi-Ctrl","Rep4-H2O2-Ctrl")


treat.fil <- tr_files %>% 
  map(~read_csv(., na = c("","NA","N/A"), col_types = cols())) %>% 
  bind_rows(.id = "Replicate") %>% 
  filter(!is.na(`group_name`)) %>% 
  select(Replicate, genotype = `group_name`, Sample, treat, HB_strain)


# combine genotype and treat variables into the flow data
data <- left_join(dat.ord, treat.fil, by = c("Replicate", "Sample"))

# get the RS1 data output into csv file
write.csv(data, file = "output/RS1.csv", row.names = F)
write.csv(data, file = "../RS_TrunV/input/RS1.csv", row.names = F)
```

### CTA1 induction during -Pi [Fig. 4A]
Get the subset of no Pi data
```{r}
# recode the genotype
levels <- c(`WT` = "wt", `IS_2.4` = "RS1_24",  `IS_2.6` = "RS1_26", `IS_2.8` = "RS1_28", `IS_2.10` = "RS1_210")
G.levels <- c("WT", "IS_2.4", "IS_2.6", "IS_2.8", "IS_2.10")

pi.dat <- data %>% 
  filter(treat == "0Pi") %>%  # , HB_strain != "yH298"
  select(Time = Group, Sample, Plate, replicate = Replicate, genotype, median, Strain = HB_strain) %>%
  mutate(Genotype = fct_recode(genotype, `WT` = "wt", `IS_2.4` = "RS1_24",  `IS_2.6` = "RS1_26", `IS_2.8` = "RS1_28", `IS_2.10` = "RS1_210")) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)%>% 
  mutate(genotype = factor(genotype, levels = levels))%>% 
  mutate(rP_series = fct_recode(genotype, `WT` = "wt", `rP1` = "RS1_24",  `rP2` = "RS1_26", `rP3` = "RS1_28", `rP4` = "RS1_210" ))

h2o2.dat <- data %>% 
  filter(treat == "2mMH2O2") %>% 
  select(Time = Group, Sample, Plate, replicate = Replicate, genotype, median, Strain = HB_strain) %>%
  mutate(Genotype = fct_recode(genotype, `WT` = "wt", `IS_2.4` = "RS1_24",  `IS_2.6` = "RS1_26", `IS_2.8` = "RS1_28", `IS_2.10` = "RS1_210")) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)%>% 
  mutate(genotype = factor(genotype, levels = levels)) %>% 
  mutate(rP_series = fct_recode(genotype, `WT` = "wt", `rP1` = "RS1_24",  `rP2` = "RS1_26", `rP3` = "RS1_28", `rP4` = "RS1_210" ))
```

#### Full time course
```{r}
names(genotype_color) <- names(levels)

pi.dat %>%
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels), option = "rocket")  +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/Rs1_0Pi.png", width = 6, height = 8)

h2o2.dat %>%
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels), option = "rocket")  +
  theme(legend.position=c(0.75,0.9)) +
  labs(x = "2mM H2O2, Time (min)")
#ggsave("output/Rs1_2mMH2O2.png", width = 6, height = 8)

#Generate a darker subset of colors
n_colors <- 7 # Generate more colors than needed
full_palette <- brewer.pal(n_colors, "YlGnBu")
darker_palette <- full_palette[7:3] # Select a subset of darker colors

#Create a scale for the darker colors
scale_darker_ygb <- scale_color_manual(values = darker_palette)

pi.dat %>%
filter(!is.na(new_median), genotype != "rescue") %>%
ggplot(aes(x = new_time, y = new_median, color = rP_series)) + p.timecourse +
scale_darker_ygb +
labs(x = "Phosphate starvation, Time (min)")+
theme(
axis.title.x = element_blank(),
axis.title.y = element_blank()
)
ggsave("output/RS1_0Pi_ygb.png", width = 3.7, height = 6)

h2o2.dat %>%
filter(!is.na(new_median), genotype != "rescue") %>%
ggplot(aes(x = new_time, y = new_median, color = rP_series)) + p.timecourse +
scale_darker_ygb +
labs(x = "Phosphate starvation, Time (min)")+
theme(
axis.title.x = element_blank(),
axis.title.y = element_blank()
)
ggsave("output/RS1_oxi_ygb.png", width = 3.7, height = 6)



# only wt
rs.data <- data %>% 
  filter(!is.na(median)) %>%  # , HB_strain != "yH298"
  select(Time = Group, Sample, Plate, replicate = Replicate, genotype, median, Strain = HB_strain, treat) %>%
  mutate(Genotype = fct_recode(genotype, `WT` = "wt", `IS_2.4` = "RS1_24",  `IS_2.6` = "RS1_26", `IS_2.8` = "RS1_28", `IS_2.10` = "RS1_210")) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)%>% 
  mutate(genotype = factor(genotype, levels = levels))
    
rs.data %>% 
  filter(!is.na(new_median), Genotype == "WT") %>% 
  ggplot(aes(x = new_time, y = new_median, color = treat, shape = treat)) + p2.timecourse +
  scale_color_manual(values = c("#674ea7ff","#e69138ff","#666666ff"))  +
  scale_shape_manual(values = c(16, 17, 15)) +
  xlab("Time (min)")
#ggsave("output/WT.png", width = 6, height = 6.6)

```
```{r}
p2.timecourse <- list(
  stat_summary(fun = "mean", geom = "point", size = 5),
  stat_summary(fun.data = "mean_cl_boot", geom = "errorbar", width = 3),
  stat_smooth(aes(size = Genotype == "WT"), method = "loess", 
              formula = 'y~x', se = FALSE),
  scale_x_continuous(breaks = seq(0,240,30)),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  labs(x = "Time (min)", y = "Cta1-GFP protein level (a.u.)"),
  theme_cowplot(line_size = 0.7, font_size = 20),
  theme(legend.position="top",
        legend.justification = "center",
        #legend.direction = "horizontal",
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 1,size = 20), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)

rs.data %>% 
  filter(!is.na(new_median), Genotype == "WT") %>% 
  ggplot(aes(x = new_time, y = new_median, color = treat, shape = treat),labels = c("-Pi", bquote(~H[2]*O[2]), "Mock")) +  
  p2.timecourse +
  scale_color_manual(values = c("#674ea7ff","#e69138ff","#666666ff"),labels = c("-Pi", bquote(~H[2]*O[2]), "Mock"))  +
  scale_shape_manual(values = c(16, 17, 15),labels = c("-Pi", bquote(~H[2]*O[2]), "Mock")) +
  guides(color = guide_legend(nrow = 1, title = NULL), shape = guide_legend(nrow = 1, override.aes = list(size = 4), title = NULL)) +
  xlab("Time (min)")
ggsave("output/WT.png", width = 7, height = 7)
```

## Basal expression level of RS variants
```{r}
# Use 0min data from both H2O2 and -Pi treatment; 
data.RS <- data %>% filter(treat != "Ctrl")%>%  
  select(Time = Group, Sample, Plate, replicate = Replicate, genotype, median, Strain = HB_strain, Treatment = treat) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate) %>% 
  mutate(genotype = factor(genotype, levels = levels)) %>% 
  mutate(Genotype = factor(Genotype, levels = G.levels))


## seperately plot the basal level for 0mM Pi and 2mM H2O2
data.RS %>%
  filter(!is.na(new_median), Time == "0min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels), option = "rocket") +
  theme(legend.position=c(0.75,0.85)) +
  xlab("Random Sequence(RS) Variants, 0 min") +
  facet_grid(. ~ Treatment) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), legend.position="none")
#ggsave("output/RS1_seperate_basal.png", width = 6, height = 8)

## plot the 0mM Pi and 2mM H2O2 basal side by side
data.RS %>% 
  filter(!is.na(new_median), Time == "0min") %>% 
  ggplot(aes(x = Genotype, y = new_median, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
  geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Red", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 4)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 3, col = "gray", linetype = "dashed") +
  xlab("Internal swap (IS) variants") +
  ylab("Basal exp (a.u.)") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), legend.position = "none")
#ggsave("output/IS_basal_bar.png", width = 10.16, height = 2)

# calculate relative basal expression changes to wt
rs.bas.rel.pi <- data.RS %>% 
          filter(!is.na(new_median), Time == "0min", Treatment == "0Pi") %>% 
          group_by(genotype) %>% 
          mutate(new_mean_base = mean(median)) %>% 
          mutate(wt_basal = mean(.[.$Genotype == "WT",]$new_mean_base)) %>% 
          mutate(rel_base = median/wt_basal) %>% 
          mutate(Treatment = "0Pi")

rs.bas.rel.oxi <- data.RS %>% 
          filter(!is.na(new_median), Time == "0min", Treatment == "2mMH2O2") %>% 
          group_by(genotype) %>% 
          mutate(new_mean_base = mean(median)) %>% 
          mutate(wt_basal = mean(.[.$Genotype == "WT",]$new_mean_base)) %>% 
          mutate(rel_base = median/wt_basal) %>% 
          mutate(Treatment = "2mMH2O2")

rs.bas.rel <- bind_rows(rs.bas.rel.oxi, rs.bas.rel.pi)
rs.bas.rel.save <- rs.bas.rel %>% select(Time, genotype, Genotype, rel_base, Treatment)
write.csv(rs.bas.rel.save, file = "output/rs_bas_rel.csv", row.names = F)
write.csv(rs.bas.rel.save, file = "../Trun_OL/input/rs_bas_rel.csv", row.names = F)

rs.bas.rel %>% 
  filter(!is.na(rel_base), Time == "0min") %>% 
  ggplot(aes(x = Genotype, y = rel_base, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
  geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Red", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 1.5)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("Internal swap (IS) variants") +
  ylab("Basal exp (a.u.)") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"))
#ggsave("output/IS_basal_rel_bar.png", width = 10.16, height = 2)

```
## Plateau/maximum expression Level of OL variants (V1)
The logic is cancel out the impact of basal expression level of each variants. To do so, minus the 0 min basal expression level from each variants, then plot the deduced data at all tp and the selected tp.
```{r}
# get the individual basal mean
pi.basal <- pi.dat %>% filter(!is.na(median), Time == "0min") %>% group_by(genotype) %>% mutate(basal = median) %>% select(replicate, Strain, genotype, basal)

oxi.basal <- h2o2.dat %>% filter(!is.na(median), Time == "0min") %>% group_by(genotype) %>% mutate(basal = median) %>% select(replicate, Strain, genotype, basal)

# calculate the new CTA1-GFP (a.u.) by decuding the 0 min number for individual strain

pi.dect <- merge(pi.dat, pi.basal, by = c("Strain", "replicate","genotype")) %>% 
  select(Time, replicate, genotype, median, basal) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =(median-basal)/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  mutate(genotype = factor(genotype, levels = levels)) %>% 
  arrange(new_time, genotype, replicate) %>% 
  mutate(Genotype = factor(Genotype, levels = G.levels))

oxi.dect <- merge(h2o2.dat, oxi.basal, by = c("Strain", "replicate","genotype")) %>% 
  select(Time, replicate, genotype, median, basal) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =(median-basal)/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  mutate(genotype = factor(genotype, levels = levels)) %>% 
  arrange(new_time, genotype, replicate) %>% 
  mutate(Genotype = factor(Genotype, levels = G.levels))

# timecourse deduct curve
pi.dect %>%
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels), option = "rocket") +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/RS1_0Pi_deduct.png", width = 6, height = 8)

oxi.dect %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels), option = "rocket") +
  labs(x = "2mM H2O2, Time (min)")
#ggsave("output/RS1_oxi_deduct.png", width = 6, height = 8)


# single timepoint deduct curve


# - Pi: 240min
pi.dect %>% 
  filter(!is.na(new_median), Time == "240min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  theme(legend.position=c(0.75,0.85)) +
  scale_color_viridis_d(limits = names(levels), option = "rocket") +
  xlab("Random Sequence(RS) Variants, 0mM Pi, 240 min")
#ggsave("output/RS1_deduct_0Pi_240.png", width = 6, height = 8)


# 2mM Oxi: 90min
oxi.dect %>% 
  filter(!is.na(new_median), Time == "90min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  theme(legend.position=c(0.75,0.85)) +
  scale_color_viridis_d(limits = names(levels), option = "rocket") +
  xlab("Random Sequence(RS) Variants, 2mM H2O2, 90 min")
#ggsave("output/RS1_deduct_Oxi_90.png", width = 6, height = 8)

# calculate maximum plateau relative to wt
pi.rs.dect.rel <- pi.dect %>% filter(Time == "240min") %>% group_by(genotype) %>% 
  mutate(new_mean_ori = mean(median)) %>% 
  mutate(new_mean_red = mean(new_median)) %>% 
  mutate(wt_ori = mean(.[.$Genotype == "WT",]$new_mean_ori)) %>% 
  mutate(wt_red = mean(.[.$Genotype == "WT",]$new_mean_red)) %>% 
  mutate(rel_ori = median/wt_ori) %>% 
  mutate(rel_red = new_median/wt_red) %>% 
  mutate(Treatment = "0Pi")
  
oxi.rs.dect.rel <- oxi.dect %>% filter(Time == "90min") %>% group_by(genotype) %>% 
  mutate(new_mean_ori = mean(median)) %>% 
  mutate(new_mean_red = mean(new_median)) %>% 
  mutate(wt_ori = mean(.[.$Genotype == "WT",]$new_mean_ori)) %>% 
  mutate(wt_red = mean(.[.$Genotype == "WT",]$new_mean_red)) %>% 
  mutate(rel_ori = median/wt_ori) %>% 
  mutate(rel_red = new_median/wt_red) %>% 
  mutate(Treatment = "2mMH2O2")


rs.rel <- bind_rows(pi.rs.dect.rel, oxi.rs.dect.rel) %>% mutate(Genotype = factor(Genotype, levels = G.levels))

# plot the maximum relative to wt
rs.rel %>% 
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = Genotype, y = rel_ori, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
  geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Red", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 1.5)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("Internal removal (IR) variants") +
  ylab("Max induction (relative to wt,ori)") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"))
#ggsave("output/OL_ori_rel_max.png", width = 10.16, height = 2)



rs.rel %>% 
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = Genotype, y = rel_red, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
  geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Red", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 1.5)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("Internal removal (IR) variants") +
  ylab("Plateau") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), legend.position=c(0.8,0.9))
#ggsave("output/OL_red_rel_max.png", width = 10.16, height = 2)

rs.rel.plateau <- rs.rel %>% select(Time, Genotype, genotype, Treatment, rel_ori, rel_red)
write.csv(rs.rel.plateau, file = "output/rs_plateau.csv", row.names = F)
write.csv(rs.rel.plateau, file = "../Trun_OL/input/rs_plateau.csv", row.names = F)
```
### slope/differetiation of the loess curve
```{r}
# plot & calculate the slope/differiation changes of OL:- Pi

# check the non-duplicated strain names
check <- pi.dat %>%  group_by(Genotype) %>% summarise(Strain = paste(unique(Strain), collapse = ', '))

# Can play the the genotype name to plot the diff(loess model)
test.pi <- pi.dat %>% filter(Genotype == "IS_2.4") %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 

x <- 0:240
px <- predict(test.pi, newdata = x)
px1 <- diff(px)
which.max(px1) # get the x value
max(px1) # equals px1[which.max(px1)]

par(mfrow=c(1, 2))
plot(x, px, main="loess model")

plot(x[-1], px1, main="diff(loess model)")
abline(v=which.max(px1), col="red")

# get the max slope and the respective tp for each sample into a dataframe: - Pi 
pi.slope <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("slope", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(levels)) {
  tmp.pi <- pi.dat %>% filter(Genotype == x)
# get the loess function
  for (y in unique(pi.dat$replicate)) {
    test.pi <- tmp.pi %>% filter(replicate == y) 
    for (z in unique(test.pi$Strain)) {
      final.pi <- test.pi %>% filter(Strain == z) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2)
      x_var <- 0:240
      px <- predict(final.pi, newdata = x_var)
      # perform differentiation
      tmp <- max(diff(px))
      gt_tmp <- x
      pi.slope[row_cnt,col_cnt] <- tmp
      col_cnt = col_cnt + 1
      pi.slope[row_cnt,col_cnt] <- gt_tmp
      col_cnt = 1
      row_cnt = row_cnt + 1
    }}}


pi.slope <- pi.slope %>% 
  mutate(Genotype = factor(Genotype, levels =G.levels)) %>% 
  mutate(Treatment = "0Pi")

# plot the slope of the curve: - Pi
pi.slope %>% 
  filter(!is.na(slope)) %>% 
  ggplot(aes(x = Genotype, y = slope, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  theme(legend.position="none") +
  scale_color_viridis_d(limits = names(levels), option = "rocket") +
  ylab("Maximum Slope (loess fit)") +
  xlab("Random Sequence(RS)  Variants, 0mM Pi")
ggsave("output/RS1_slope_0Pi.png", width = 6, height = 8)


# get the max slope and the respective tp for each sample into a dataframe: 2mM H2O2 
oxi.slope <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("slope", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(levels)) {
  tmp.oxi <- h2o2.dat %>% filter(Genotype == x)
# get the loess function
  for (y in unique(h2o2.dat$replicate)) {
    test.oxi <- tmp.oxi %>% filter(replicate == y) 
    for (z in unique(test.oxi$Strain)) {
      final.oxi <- test.oxi %>% filter(Strain == z) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2)
      x_var <- 0:240
      px <- predict(final.oxi, newdata = x_var)
      # perform differentiation
      tmp <- max(diff(px))
      gt_tmp <- x
      oxi.slope[row_cnt,col_cnt] <- tmp
      col_cnt = col_cnt + 1
      oxi.slope[row_cnt,col_cnt] <- gt_tmp
      col_cnt = 1
      row_cnt = row_cnt + 1
    }}}


oxi.slope <- oxi.slope %>% 
  mutate(Genotype = factor(Genotype, levels =G.levels)) %>% 
  mutate(Treatment = "2mMH2O2")

# plot the slope of the curve: - Pi
oxi.slope %>% 
  filter(!is.na(slope), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = slope, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  theme(legend.position= "none") +
  scale_color_viridis_d(limits = names(levels), option = "rocket") +
  ylab("Maximum Slope (loess fit)") +
  xlab("Random Sequence(RS) Variants, 2mM H2O2")
ggsave("output/RS1_slope_oxi.png", width = 6, height = 8)


# get the maximum slope relative to the wt
pi.slope.rel <- pi.slope %>% filter(!is.na(slope)) %>% 
  group_by(Genotype) %>% 
  mutate(mean_slope = mean(slope)) %>%
  mutate(wt_slope = mean(.[.$Genotype == "WT",]$mean_slope)) %>% 
  mutate(rel_slope = slope/wt_slope) 

oxi.slope.rel <- oxi.slope %>% filter(!is.na(slope)) %>% 
  group_by(Genotype) %>% 
  mutate(mean_slope = mean(slope)) %>%
  mutate(wt_slope = mean(.[.$Genotype == "WT",]$mean_slope)) %>% 
  mutate(rel_slope = slope/wt_slope) 

# get the combined slope
rs.slope <- bind_rows(pi.slope.rel, oxi.slope.rel)
rs.slope.store <- rs.slope %>% select(slope, Genotype, Treatment, rel_slope)
write.csv(rs.slope.store, file = "output/rs_slope_rel.csv", row.names = F)
write.csv(rs.slope.store, file = "../Trun_OL/input/rs_slope_rel.csv", row.names = F)

# plot the maximum slope relative to wt
rs.slope %>% 
  filter(!is.na(rel_slope), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = rel_slope, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Red", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 1.5)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("Internal swap (IS) variants") +
  ylab("Max Slope") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), legend.position= "none")
#ggsave("output/IS_slope_rel_max.png", width = 10.16, height = 2)

```

#### Get the loess curve fitting for the timecourse data
```{r}
# check for the loss fit curve
pi.model <- pi.dat  %>%   
group_by(Genotype) %>%
mutate(model = loess(median ~ new_time, span = 0.75, degree = 2)$fitted)

h2o2.model <- h2o2.dat  %>%   
group_by(Genotype) %>%
mutate(model = loess(median ~ new_time, span = 0.75, degree = 2)$fitted)

pi.model %>% ggplot(aes(x = new_time, y = new_median, color = Genotype)) + mean.timecourse + scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/loess_Rs1_0Pi.png", width = 6.3, height = 8)

h2o2.model %>% ggplot(aes(x = new_time, y = new_median, color = Genotype)) + mean.timecourse + scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
labs(x = "2mM H2O2, Time (min)")
#ggsave("output/loess_Rs1_2mMH2O2.png", width = 6.3, height = 8)


## test codes for calculating mean value before loess fit
#pi.model.test <- pi.model %>% group_by(Genotype,new_time) %>% summarise(ave_median = mean(median)) %>% mutate(model = loess(ave_median ~ new_time, span = 0.75, degree = 2)$fitted)

#pi.model.test %>% ggplot(aes(x = new_time, y = model, color = Genotype)) + reduced.timecourse + geom_line(aes(y = model)) + scale_color_manual(values= genotype_color, limits = names(genotype_color))

## get AUC for - Pi data into a dataframe
pi.area <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("pi.area", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(genotype_color)) {
# calculate AUC  
madeup.pi <- pi.model %>% filter(Genotype == x) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 
f <- function(x) predict(madeup.pi,newdata=x)
# perform integration
tmp <- integrate(f,0,240)$value
gt_tmp <- x
pi.area[row_cnt,col_cnt] <- tmp
col_cnt = col_cnt + 1
pi.area[row_cnt,col_cnt] <- gt_tmp
col_cnt = 1
row_cnt = row_cnt + 1
}



# get AUC for 2mM H2O2 data
h2o2.area <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("h2o2.area", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(genotype_color)) {
# calculate AUC  
madeup.h2o2 <- h2o2.model %>% filter(Genotype == x) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 
f <- function(x) predict(madeup.h2o2,newdata=x)
# perform integration
tmp <- integrate(f,0,240)$value
gt_tmp <- x
h2o2.area[row_cnt,col_cnt] <- tmp
col_cnt = col_cnt + 1
h2o2.area[row_cnt,col_cnt] <- gt_tmp
col_cnt = 1
row_cnt = row_cnt + 1
}

# combind area data
area <- merge(pi.area,h2o2.area)
```

#### Check the loess fitting assumption: normality and curve fitting
```{r}

```

### regulatory information map
```{r}
# calculate the relative information retaining within each genotype
reg_info <- area %>% 
  mutate(pi_pcnt = pi.area/(.[.$Genotype == "WT",]$pi.area)) %>% 
  mutate(h2o2_pcnt = h2o2.area/((.[.$Genotype == "WT",]$h2o2.area)))

reg_info %>% 
  ggplot(aes(x = pi_pcnt, y = h2o2_pcnt), color = Genotype) +
  scatter + 
  geom_point(size = 3, aes(color = Genotype)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "#666666") +
  labs(x = "Pi (relative to wt)", y = "H2O2 (relative to wt)") +
  scale_color_manual(values = genotype_color, limits = names(genotype_color))
#ggsave("output/RS1vswt_0pivsh2o2_scatter.png", width = 6.3, height = 6.3)

# save the reg_info.ol 
write.csv(reg_info, file = "output/rs1_pct.csv", row.names = F)
write.csv(reg_info, file = "../RS_TrunV/input/rs1_pct.csv", row.names = F)
```