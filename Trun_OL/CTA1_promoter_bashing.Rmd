---
title: "CTA1 promoter bashing"
author: "JY"
date: "2023-11-24 (updated `r Sys.Date()`)"
output: 
  html_notebook:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r}
library(tidyverse)
library(ggtext)
#library(mgcv)
#library(broom)
library(cowplot)
```

## Goal
Plot the dynamics for CTA1 promoter bashing variants under - Pi and 2 mM H2O2 treatment

## Common plotting functions
**Update 2022-11-08** 
This list is used as a shared plotting set up.
```{r}
p.timecourse <- list(
  stat_summary(fun = "mean", geom = "point", size = 3),
  stat_summary(fun.data = "mean_cl_boot", geom = "errorbar", width = 3),
  stat_smooth(aes(size = Genotype == "WT"), method = "loess", 
              formula = 'y~x', se = FALSE),
  scale_x_continuous(breaks = seq(0,240,30)),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  labs(x = "Time (min)", y = "Cta1-GFP protein level (a.u.)"),
  theme_cowplot(line_size = 0.7, font_size = 14),
  theme(legend.position=c(0.05,0.75), 
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 3), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)

mean.timecourse <- list(
  stat_summary(fun = "mean", geom = "point", size = 3),
  stat_smooth(aes(size = Genotype == "WT"), method = "loess", 
              formula = 'y~x', se = FALSE),
  scale_x_continuous(breaks = seq(0,240,30)),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  labs(x = "Time (min)", y = "Cta1-GFP protein level (a.u.)"),
  theme_cowplot(line_size = 0.7, font_size = 14),
  theme(legend.position=c(0.02,0.9),
        #legend.direction = "horizontal",
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 3), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)



scatter <- list(stat_summary(fun = "mean", geom = "point", size = 3),
                scale_y_continuous(breaks = seq(0,1.0,0.25)),
                scale_x_continuous(breaks = seq(0,1.0,0.25)),
                scale_size_manual(values = c(0.8, 1.5), guide = "none"),
                expand_limits(x = 0, y = 0),
                theme_cowplot(line_size = 0.7, font_size = 14),
                theme(legend.position=c(0.02,0.82),
                legend.text = element_text(face = 3), 
                legend.title = element_text(),
                axis.title = element_text(size = rel(1)), 
                axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1))))

bar.list <- list(
  stat_summary(fun.data = "mean_cl_boot", conf.int = .95, colour = "red", linewidth = 1, size = 0.8),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  labs(x =paste0("2mM H2O2, OL variants ", deparse1(substitute(input_tp)), " min"), y = "Cta1-GFP protein level (a.u.)"),
  theme_cowplot(line_size = 0.7, font_size = 14),
  theme(legend.position=c(0.02,0.9),
        #legend.direction = "horizontal",
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 3), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)


```

## CTA1 induction in OL variants

#### -Pi Data
Import data and get the replicate, time and genotype info
```{r}
files <- dir("input/OL_0Pi", pattern = "d01*") # get the file names of the merged
files <- file.path("input//OL_0Pi", files)         # this appends the directory to the file names
names(files) <- c("Rep1-0Pi-Ctrl","Rep2-0Pi-Ctrl", "Rep3-0Pi-Ctrl")

tp <- c("0min",  "30min", "60min", "90min", "120min", "150min",  "180min", "210min", "240min") # ordered time points

# import and process the data to the format we want
data.ol.pi <- map_dfr(files, ~read_csv(., na = c("", "NA", "N/A"), col_types = cols()), .id = "Replicate") %>% 
  #bind_rows(.id = "Replicate") %>% 
  filter(`X Parameter` == "BL1-H", is.na(`Y Parameter`)) %>% 
  select(Replicate, Group, Sample, Count, median = `X Median`, peak = `X Peak`,
         sd = `X SD`, cv = `X %CV`, rCV = `X %rCV`) %>% 
  separate(Group, into = c('Time', 'Treatment'), sep = "-") %>% 
  mutate(Time = ordered(Time, levels = tp)) %>% 
  mutate(Sample = case_when(Sample == "CTA1-GFP-yH298" ~ "yH298-wt",
            Sample == "CTA1-GFP-yH299" ~ "yH299-wt",
            Sample == "yH343-wt" ~ "yH343-rescue",
            Sample == "yH344-wt" ~ "yH344-rescue",
            TRUE ~ Sample)) %>% 
  mutate(Replicate = gsub("\\-.*","", Replicate)) %>% # 
  separate(Sample, into = c("Strain", "genotype"), sep = "-") %>% 
  arrange(Time)
# To replace the value: ifelse() for a single test, case_when() for multiple test
# \\-: escape character "\\" used to escape the special meaning of -, instead take - as a common regex pattern. Or we can specify the - as a regex pattern within a square bracket class [-]
#.*: This part matches any sequence of characters (.* is a common regex pattern for "any character, zero or more times"). metacharacter
```


#### under -Pi
Plot the internal removal variants data(OL)
```{r}
# recode the genotype
levels <- c(WT = "wt", PC = "rescue",`4OL` = "4OL", `6OL` = "6OL", `8OL` = "8OL", `10OL` = "10OL")
levels.norescue <- c(WT = "wt",`4OL` = "4OL", `6OL` = "6OL", `8OL` = "8OL", `10OL` = "10OL")

pi.ol.dat <- data.ol.pi %>% 
  filter(genotype %in% c("wt", "4OL", "6OL", "8OL", "10OL","rescue")) %>%  
  select(Time, replicate = Replicate, genotype, median) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)

pi.ol.dat %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels.norescue))  +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/OL_0Pi_norescue.png", width = 6, height = 8)
```
#### 2mM H2O2 Data
Import 2mM H2O2 OL data and get the replicate, time and genotype info
```{r}
files <- dir("input/OL_2mMH2O2", pattern = "d*") # get the file names of the merged
files <- file.path("input//OL_2mMH2O2", files)      # this appends the directory to the file names
names(files) <- c("Rep1-2mMH2O2","Rep2-2mMH2O2", "Rep3-2mMH2O2", "Rep4-2mMH2O2")

tp <- c("0min",  "30min", "60min", "90min", "120min", "150min",  "180min", "210min", "240min") # ordered time points

# import and process the data to the format we want
data.ol.oxi <- map_dfr(files, ~read_csv(., na = c("", "NA", "N/A"), col_types = cols()), .id = "Replicate") %>% 
  #bind_rows(.id = "Replicate") %>% 
  filter(`X Parameter` == "BL1-H", is.na(`Y Parameter`)) %>% 
  select(Replicate, Group, Sample, Count, median = `X Median`, peak = `X Peak`,
         sd = `X SD`, cv = `X %CV`, rCV = `X %rCV`) %>% 
  separate(Group, into = c('Time', 'Treatment'), sep = "-") %>% 
  mutate(Time = ordered(Time, levels = tp)) %>% 
  mutate(Sample = case_when(Sample == "CTA1-GFP-yH298" ~ "yH298-wt",
            Sample == "CTA1-GFP-yH299" ~ "yH299-wt",
            Sample == "yH343-wt" ~ "yH343-rescue",
            Sample == "yH344-wt" ~ "yH344-rescue",
            TRUE ~ Sample)) %>% 
  mutate(Replicate = gsub("\\-.*","", Replicate)) %>% # 
  separate(Sample, into = c("Strain", "genotype"), sep = "-") %>% 
  arrange(Time)
# To replace the value: ifelse() for a single test, case_when() for multiple test
# \\-: escape character "\\" used to escape the special meaning of -, instead take - as a common regex pattern. Or we can specify the - as a regex pattern within a square bracket class [-]
#.*: This part matches any sequence of characters (.* is a common regex pattern for "any character, zero or more times"). metacharacter
```


#### under 2mM H2O2
Plot the internal removal variants data(OL)
```{r}

oxi.ol.dat <- data.ol.oxi %>% 
  filter(genotype %in% c("wt", "4OL", "6OL", "8OL", "10OL","rescue")) %>%  
  select(Time, replicate = Replicate, genotype, median) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)


oxi.ol.dat %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  xlab("2mM H2O2, time (min)")
#ggsave("output/OL_oxi.png", width = 6, height = 8)
```
## Basal expression level of OL variants
```{r}
# Use 0min data from both H2O2 and -Pi treatment; 
data.ol <- data.ol.pi %>% bind_rows(data.ol.oxi) %>%  
  select(Time, replicate = Replicate, genotype, median, Treatment) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate) %>% 
  mutate(genotype = factor(genotype, levels = levels))


data.ol %>%
  filter(!is.na(new_median), genotype != "rescue", Time == "0min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  xlab("Internal Removal (IR) Variants, 0 min")
#ggsave("output/OL_basal.png", width = 6, height = 8)

```
## Induction Level of OL variants (V1)
The logic is cancel out the impact of basal expression level of each variants. To do so, minus the 0 min basal expression level from each variants, then plot the deduced data at all tp and the selected tp.
```{r}
# get the individual basal mean
data.ol.pi.basal <- data.ol.pi %>% filter(!is.na(median), Time == "0min") %>% group_by(genotype) %>% mutate(basal = median) %>% select(Replicate, Strain, genotype, basal)

data.ol.oxi.basal <- data.ol.oxi %>% filter(!is.na(median), Time == "0min") %>% group_by(genotype) %>% mutate(basal = median) %>% select(Replicate, Strain, genotype, basal)

# calculate the new CTA1-GFP (a.u.) by decuding the 0 min number for individual strain
levels <- c(`WT `= "wt", PC = "rescue",`4OL` = "4OL", `6OL` = "6OL", `8OL` = "8OL", `10OL` = "10OL")
levels.norescue <- c(`WT `= "wt",`4OL` = "4OL", `6OL` = "6OL", `8OL` = "8OL", `10OL` = "10OL")


pi.ol.dect <- merge(data.ol.pi, data.ol.pi.basal, by = c("Strain", "Replicate","genotype")) %>% 
  filter(genotype %in% c("wt", "4OL", "6OL", "8OL", "10OL","rescue")) %>%  
  select(Time, replicate = Replicate, genotype, median, basal) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =(median-basal)/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  mutate(genotype = factor(genotype, levels = levels)) %>% 
  arrange(new_time, genotype, replicate)

oxi.ol.dect <- merge(data.ol.oxi, data.ol.oxi.basal, by = c("Strain", "Replicate","genotype")) %>% 
  filter(genotype %in% c("wt", "4OL", "6OL", "8OL", "10OL","rescue")) %>%  
  select(Time, replicate = Replicate, genotype, median, basal) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =(median-basal)/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  mutate(genotype = factor(genotype, levels = levels)) %>% 
  arrange(new_time, genotype, replicate)

# timecourse deduct curve
pi.ol.dect %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels.norescue))  +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/OL_0Pi_deduct.png", width = 6, height = 8)

oxi.ol.dect %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels.norescue))  +
  labs(x = "2mM H2O2, Time (min)")
#ggsave("output/OL_oxi_deduct.png", width = 6, height = 8)


# single timepoint deduct curve
# - Pi: 180min
pi.ol.dect %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "180min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  xlab("Internal Removal (IR) Variants, 0mM Pi, 180 min")
#ggsave("output/OL_deduct_0Pi_180.png", width = 6, height = 8)

# - Pi: 240min
pi.ol.dect %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "240min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  xlab("Internal Removal (IR) Variants, 0mM Pi, 240 min")
#ggsave("output/OL_deduct_0Pi_240.png", width = 6, height = 8)


# - Pi: 180min
pi.ol.dect %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "180min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  xlab("Internal Removal (IR) Variants, 0mM Pi, 180 min")
#ggsave("output/OL_deduct_0Pi_180.png", width = 6, height = 8)

# 2mM Oxi: 90min
oxi.ol.dect %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "90min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  xlab("Internal Removal (IR) Variants, 2mM H2O2, 90 min")
#ggsave("output/OL_deduct_Oxi_90.png", width = 6, height = 8)

```

## Induction Rate of OL variants (V2)
The logic is get the median value of each variants at 0 minutes, then calculate the relative induction rate = Vartp/Var0min
```{r}
# calculate basal mean
data.basal_mean.pi <- data.ol %>% filter(!is.na(new_median), Time == "0min", Treatment == "0Pi") %>% group_by(Genotype) %>% mutate(basal_mean = mean(new_median)) %>% select(basal_mean, genotype)

data.basal_mean.h2o2 <- data.ol %>% filter(!is.na(new_median), Time == "0min", Treatment == "2mM") %>% group_by(Genotype) %>% mutate(basal_mean = mean(new_median)) %>% select(basal_mean, genotype)

# calculate the relative induction rate 
ind.ol.pi <- left_join(pi.ol.dat, data.basal_mean.pi, by = "genotype") %>% unique() %>% 
  mutate(ind_rate = new_median/basal_mean) %>% select(-c("Genotype.y")) %>% mutate(genotype = factor(genotype, levels = levels))
colnames(ind.ol.pi)[colnames(ind.ol.pi) == 'Genotype.x'] <- 'Genotype'

ind.ol.h2o2 <- left_join(oxi.ol.dat, data.basal_mean.h2o2, by = "genotype") %>% unique() %>% 
  mutate(ind_rate = new_median/basal_mean) %>% select(-c("Genotype.y")) %>% mutate(genotype = factor(genotype, levels = levels))
colnames(ind.ol.h2o2)[colnames(ind.ol.h2o2) == 'Genotype.x'] <- 'Genotype'

# - Pi: at 180min
ind.ol.pi %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "180min") %>% 
  ggplot(aes(x = genotype, y = ind_rate, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  ylab("Relative Induction Rate") +
  xlab("Internal Removal (IR) Variants, 0mM Pi, 180 min")
#ggsave("output/OL_ind_0Pi_180.png", width = 6, height = 8)

# calculate the raw max CTA1-GFp
ind.ol.pi %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "180min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  xlab("Internal Removal (IR) Variants, 0mM Pi, 180 min")
#ggsave("output/OL_raw_0Pi_180.png", width = 6, height = 8)


# 2mM H2O2: at 90min
ind.ol.h2o2 %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "90min") %>% 
  ggplot(aes(x = genotype, y = ind_rate, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  ylab("Relative Induction Rate") +
  xlab("Internal Removal (IR) Variants, 2mM H2O2, 90 min")
#ggsave("output/OL_ind_H2O2_90.png", width = 6, height = 8)

# calculate the raw max CTA1-GFp
ind.ol.h2o2 %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "90min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  xlab("Internal Removal (IR) Variants, 2mM H2O2, 90 min")
#ggsave("output/OL_raw_H2O2_90.png", width = 6, height = 8)

```

##### 2mM H2O2 OL timepoint plot function
```{r}
tp_GFP <- function(...){
  
  all_tp <- list(...)
  for (input_tp in all_tp) {   
  
    df_tp <- oxi.ol.dat %>% filter(new_time == input_tp) %>% mutate(genotype = factor(genotype, levels = levels))
    
    print(ggplot(df_tp, aes(x = genotype, y = new_median, fill = Genotype)) + 
    geom_point() +
    stat_summary(fun.data = "mean_cl_boot", conf.int = .95, color = "Red", linewidth = 1, size = 0.8) +
    labs(x =paste0("2mM H2O2, OL variants ", deparse1(substitute(input_tp)), " min"), y = "Cta1-GFP protein level (a.u.)") +
    theme_cowplot(line_size = 0.7, font_size = 14) +
    theme(legend.position = "none",
          axis.title = element_text(size = rel(1)), 
          axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),))
  }
}

# plot the 2mM H2O2 OL variants at 0min, 90min, 120min timepoints

tp_GFP(0,90,120,240)
  

```


**Overlapping variants**
#### Get the loess curve fitting for the timecourse data
```{r}
# check for the loss fit curve
pi.ol.dat %>% ggplot(aes(x = new_time, y = new_median, color = Genotype)) + mean.timecourse + scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/loess_Ol_0Pi.png", width = 6.3, height = 8)

oxi.ol.dat %>% ggplot(aes(x = new_time, y = new_median, color = Genotype)) + mean.timecourse + scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
labs(x = "2mM H2O2, Time (min)")
#ggsave("output/loess_Ol_2mMH2O2.png", width = 6.3, height = 8)


## get AUC for - Pi data into a dataframe
pi.area <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("pi.area", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(genotype_color)) {
# calculate AUC  
madeup.pi <- pi.ol.dat %>% filter(Genotype == x) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 
f <- function(x) predict(madeup.pi,newdata=x)
# perform integration
tmp <- integrate(f,0,240)$value
gt_tmp <- x
pi.area[row_cnt,col_cnt] <- tmp
col_cnt = col_cnt + 1
pi.area[row_cnt,col_cnt] <- gt_tmp
col_cnt = 1
row_cnt = row_cnt + 1
}



# get AUC for 2mM H2O2 data
h2o2.area <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("h2o2.area", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(genotype_color)) {
# calculate AUC  
madeup.h2o2 <- oxi.ol.dat %>% filter(Genotype == x) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 
f <- function(x) predict(madeup.h2o2,newdata=x)
# perform integration
tmp <- integrate(f,0,240)$value
gt_tmp <- x
h2o2.area[row_cnt,col_cnt] <- tmp
col_cnt = col_cnt + 1
h2o2.area[row_cnt,col_cnt] <- gt_tmp
col_cnt = 1
row_cnt = row_cnt + 1
}

# combind area data
area.ol <- merge(pi.area,h2o2.area)
```

#### Check the loess fitting assumption: normality and curve fitting
```{r}

```

### regulatory information map
```{r}
# calculate the relative information retaining within each genotype
reg_info.ol <- area.ol %>% 
  mutate(pi_pcnt = pi.area/(.[.$Genotype == "WT",]$pi.area)) %>% 
  mutate(h2o2_pcnt = h2o2.area/((.[.$Genotype == "WT",]$h2o2.area)))

reg_info.ol %>% 
  ggplot(aes(x = pi_pcnt, y = h2o2_pcnt), color = Genotype) +
  scatter + 
  geom_point(size = 3, aes(color = Genotype)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "#666666") +
  labs(x = "Pi (relative to wt)", y = "H2O2 (relative to wt)") +
  scale_color_manual(values = genotype_color, limits = names(genotype_color))
#ggsave("output/Olvswt_0pivsh2o2_scatter.png", width = 6.3, height = 6.3)

# save the reg_info.ol 
write.csv(reg_info.ol, file = "output/ol_pct.csv", row.names = F)
write.csv(reg_info.ol, file = "../RS_TrunV/input/ol_pct.csv", row.names = F)
```





### Import TrunV data and get the replicate, time and genotype info
```{r}
files <- dir("input/TrunV_0Pi", pattern = "d01*") # get the file names of the merged
files <- file.path("input//TrunV_0Pi", files)         # this appends the directory to the file names
names(files) <- c("Rep1-0Pi-Ctrl","Rep2-0Pi-Ctrl", "Rep3-0Pi-Ctrl")

tp <- c("0min",  "30min", "60min", "90min", "120min", "150min",  "180min", "210min", "240min") # ordered time points

# import and process the data to the format we want
data.TrunV <- map_dfr(files, ~read_csv(., na = c("", "NA", "N/A"), col_types = cols()), .id = "Replicate") %>% 
  #bind_rows(.id = "Replicate") %>% 
  filter(!is.na(median),`X Parameter` == "BL1-H", is.na(`Y Parameter`)) %>% 
  select(Replicate, Group, Sample, Count, median = `X Median`, peak = `X Peak`,
         sd = `X SD`, cv = `X %CV`, rCV = `X %rCV`) %>% 
  separate(Group, into = c('Time', 'Treatment'), sep = "-") %>% 
  mutate(Time = ordered(Time, levels = tp)) %>% 
  mutate(Sample = case_when(Sample == "CTA1-GFP-yH298" ~ "yH298-wt",
            Sample == "CTA1-GFP-yH299" ~ "yH299-wt",
            Sample == "yH343-wt" ~ "yH343-rescue",
            Sample == "yH344-wt" ~ "yH344-rescue",
            TRUE ~ Sample)) %>% 
  mutate(Replicate = gsub("\\-.*","", Replicate)) %>%  
  separate(Sample, into = c("Strain", "genotype"), sep = "-") %>% 
  filter(!is.na(median)) %>% 
  arrange(Time) 
# To replace the value: ifelse() for a single test, case_when() for multiple test
# \\-: escape character "\\" used to escape the special meaning of -, instead take - as a common regex pattern. Or we can specify the - as a regex pattern within a square bracket class [-]
#.*: This part matches any sequence of characters (.* is a common regex pattern for "any character, zero or more times"). metacharacter
```



#### Plot the truncation variants data (TrunV)
```{r}
# recode the genotype
levels <- c(WT = "wt", `PC` = "rescue", `2V` = "2V",`4V` = "4V", `6V` = "6V", `8V` = "8V")

pi.TrunV.dat <- data.TrunV %>% 
  filter(genotype %in% c("wt", "2V", "4V", "6V", "8V","rescue")) %>%  
  select(Time, replicate = Replicate, genotype, median) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)

genotype_color <- RColorBrewer::brewer.pal(8, "Dark2")[c(8, 7, 6, 1, 5, 4)]  
names(genotype_color) <- names(levels)

pi.TrunV.dat %>%
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  xlab("Phosphate starvation, time (min)")
  #scale_y_continuous(limits = c(NA, 22))

#ggsave("output/TrunV_0Pi.png", width = 6, height = 8)
```
#### 2mM H2O2 Data
Import 2mM H2O2 TrunV data and get the replicate, time and genotype info
```{r}
files <- dir("input/TrunV_2mMH2O2", pattern = "d*") # get the file names of the merged
files <- file.path("input//TrunV_2mMH2O2", files)      # this appends the directory to the file names
names(files) <- c("Rep1-2mMH2O2","Rep2-2mMH2O2", "Rep3-2mMH2O2")

tp <- c("0min",  "30min", "60min", "90min", "120min", "150min",  "180min", "210min", "240min") # ordered time points

# import and process the data to the format we want
data.TrunV.oxi <- map_dfr(files, ~read_csv(., na = c("", "NA", "N/A"), col_types = cols()), .id = "Replicate") %>% 
  #bind_rows(.id = "Replicate") %>% 
  filter(`X Parameter` == "BL1-H", is.na(`Y Parameter`)) %>% 
  select(Replicate, Group, Sample, Count, median = `X Median`, peak = `X Peak`,
         sd = `X SD`, cv = `X %CV`, rCV = `X %rCV`) %>% 
  separate(Group, into = c('Time', 'Treatment'), sep = "-") %>% 
  mutate(Time = ordered(Time, levels = tp)) %>% 
  mutate(Sample = case_when(Sample == "CTA1-GFP-yH298" ~ "yH298-wt",
            Sample == "CTA1-GFP-yH299" ~ "yH299-wt",
            Sample == "yH343-wt" ~ "yH343-rescue",
            Sample == "yH344-wt" ~ "yH344-rescue",
            TRUE ~ Sample)) %>% 
  mutate(Replicate = gsub("\\-.*","", Replicate)) %>% # 
  separate(Sample, into = c("Strain", "genotype"), sep = "-") %>% 
  filter(!is.na(median)) %>% 
  arrange(Time)
# To replace the value: ifelse() for a single test, case_when() for multiple test
# \\-: escape character "\\" used to escape the special meaning of -, instead take - as a common regex pattern. Or we can specify the - as a regex pattern within a square bracket class [-]
#.*: This part matches any sequence of characters (.* is a common regex pattern for "any character, zero or more times"). metacharacter
```


#### under 2mM H2O2
Plot the Truncation variants data(TrunV)
```{r}
# recode the genotype
levels <- c(WT = "wt", `PC` = "rescue", `2V` = "2V",`4V` = "4V", `6V` = "6V", `8V` = "8V")

oxi.TrunV.dat <- data.TrunV.oxi  %>% 
  filter(genotype %in% c("wt", "2V", "4V", "6V", "8V","rescue")) %>%  
  select(Time, replicate = Replicate, genotype, median) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)

genotype_color <- RColorBrewer::brewer.pal(8, "Dark2")[c(8, 7, 6, 1, 5, 4)]  
names(genotype_color) <- names(levels)

oxi.TrunV.dat %>%
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  xlab("2mM H2O2 stress, time (min)")
  #scale_y_continuous(limits = c(NA, 22))

#ggsave("output/TrunV_oxi.png", width = 6, height = 8)

##### 2mM H2O2 OL timepoint plot function
tp_GFP <- function(...){
  
  all_tp <- list(...)
  for (input_tp in all_tp) {   
  
    df_tp <- oxi.TrunV.dat %>% filter(new_time == input_tp) %>% mutate(genotype = factor(genotype, levels = levels))
    
    print(ggplot(df_tp, aes(x = genotype, y = new_median, fill = Genotype)) + 
    geom_point() +
    stat_summary(fun.data = "mean_cl_boot", conf.int = .95, color = "Red", linewidth = 1, size = 0.8) +
    labs(x =paste0("2mM H2O2, OL variants ", deparse1(substitute(input_tp)), " min"), y = "Cta1-GFP protein level (a.u.)") +
    theme_cowplot(line_size = 0.7, font_size = 14) +
    theme(legend.position = "none",
          axis.title = element_text(size = rel(1)), 
          axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),))
  }
}

# plot the 2mM H2O2 OL variants at 0min, 90min, 120min timepoints

tp_GFP(0,90,120,240)

```
** Truncation variants**
#### Get the loess curve fitting for the timecourse data
```{r}
# check for the loss fit curve
pi.model <- pi.TrunV.dat  %>%   
group_by(Genotype) %>%
mutate(model = loess(median ~ new_time, span = 0.75, degree = 2)$fitted)

h2o2.model <- oxi.TrunV.dat  %>%   
group_by(Genotype) %>%
mutate(model = loess(median ~ new_time, span = 0.75, degree = 2)$fitted)

pi.model %>% ggplot(aes(x = new_time, y = new_median, color = Genotype)) + mean.timecourse + scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/loess_TrunV_0Pi.png", width = 6.3, height = 8)

h2o2.model %>% ggplot(aes(x = new_time, y = new_median, color = Genotype)) + mean.timecourse + scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
labs(x = "2mM H2O2, Time (min)")
#ggsave("output/loess_TrunV_2mMH2O2.png", width = 6.3, height = 8)


## get AUC for - Pi data into a dataframe
pi.area <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("pi.area", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(genotype_color)) {
# calculate AUC  
madeup.pi <- pi.model %>% filter(Genotype == x) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 
f <- function(x) predict(madeup.pi,newdata=x)
# perform integration
tmp <- integrate(f,0,240)$value
gt_tmp <- x
pi.area[row_cnt,col_cnt] <- tmp
col_cnt = col_cnt + 1
pi.area[row_cnt,col_cnt] <- gt_tmp
col_cnt = 1
row_cnt = row_cnt + 1
}



# get AUC for 2mM H2O2 data
h2o2.area <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("h2o2.area", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(genotype_color)) {
# calculate AUC  
madeup.h2o2 <- h2o2.model %>% filter(Genotype == x) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 
f <- function(x) predict(madeup.h2o2,newdata=x)
# perform integration
tmp <- integrate(f,0,240)$value
gt_tmp <- x
h2o2.area[row_cnt,col_cnt] <- tmp
col_cnt = col_cnt + 1
h2o2.area[row_cnt,col_cnt] <- gt_tmp
col_cnt = 1
row_cnt = row_cnt + 1
}

# combind area data
area <- merge(pi.area,h2o2.area)
```

#### Check the loess fitting assumption: normality and curve fitting
```{r}

```

### regulatory information map
```{r}
# calculate the relative information retaining within each genotype
reg_info <- area %>% 
  mutate(pi_pcnt = pi.area/(.[.$Genotype == "WT",]$pi.area)) %>% 
  mutate(h2o2_pcnt = h2o2.area/((.[.$Genotype == "WT",]$h2o2.area)))

reg_info %>% 
  ggplot(aes(x = pi_pcnt, y = h2o2_pcnt), color = Genotype) +
  scatter + 
  geom_point(size = 3, aes(color = Genotype)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "#666666") +
  labs(x = "Pi (relative to wt)", y = "H2O2 (relative to wt)") +
  scale_color_manual(values = genotype_color, limits = names(genotype_color))
#ggsave("output/TrunVvswt_0pivsh2o2_scatter.png", width = 6.3, height = 6.3)
```





**test code**
**_1st Differential derivative (Slope) for each curve_**
```{r}
wt.test <- oxi.dat %>% filter(genotype %in% c("wt"))

fit.wt <- loess(new_median~new_time, data=wt.test)

x <- 0:240
px <- predict(fit.wt, newdata = x)
px1 <- diff(px)
#which.max(px1)

wt.loess <- tibble(x = x, y = px)
wt.diff <- tibble (x = x[-1], y = px1)

twoV.test <- oxi.dat %>% filter(genotype %in% c("2V"))

fit.twoV <- loess(new_median~new_time, data=twoV.test)

x <- 0:240
px.2V <- predict(fit.twoV, newdata = x)
px1.2V <- diff(px.2V)

twoV.loess <- tibble(x = x, y = px.2V)
twoV.diff <- tibble (x = x[-1], y = px1.2V)

par(mfrow=c(1, 4))
wt.loess %>% 
ggplot(aes(x = x, y = y)) + geom_point(size = 1, alpha = 0.5) + scale_x_continuous(breaks = seq(0,240,30)) + theme_bw() + ggtitle("loess model")

wt.diff %>% 
  ggplot(aes(x = x, y = y)) + geom_point(size = 1, alpha = 0.5)+ scale_x_continuous(breaks = seq(0, 240, 30)) + theme_bw() + ggtitle("diff(loess model)")


twoV.loess %>% 
ggplot(aes(x = x, y = y)) + geom_point(size = 1, alpha = 0.5) + scale_x_continuous(breaks = seq(0,240,30)) + theme_bw() + ggtitle("loess model")

twoV.diff %>% 
  ggplot(aes(x = x, y = y)) + geom_point(size = 1, alpha = 0.5)+ scale_x_continuous(breaks = seq(0, 240, 30)) + theme_bw() + ggtitle("diff(loess model)")


```
```{r}
fit.wt$


```



**_Statistical test_**

1. Basal level
```{r}
# filter the data and set the basal level
genotype_order <- names(levels)

tmp <- pi.dat %>% 
  filter(new_time == 0, !is.na(new_median)) %>% 
  mutate(Genotype = factor(Genotype, levels = genotype_order))
lm(new_median ~ Genotype, data = tmp) %>% 
  summary()
  #TukeyHSD()
```
2. At 120 minutes
```{r}
tmp <- pi.dat %>% 
  filter(new_time == 120, !is.na(new_median)) %>% 
  mutate(Genotype = factor(Genotype, levels = genotype_order))
lm(new_median ~ Genotype, data = tmp) %>% 
  summary()
```
#### under mock treatment.

Get the subset of Ctrl data
```{r}
ctrl.dat <- data %>% 
  filter(treat == "ctrl", genotype %in% levels) %>%  
  select(Time = Group, Sample, Plate, replicate = Replicate, genotype, median) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)
```

```{r}
genotype_color <- RColorBrewer::brewer.pal(8, "Dark2")[c(8, 7, 2)] 
names(genotype_color) <- names(levels)

ctrl.dat %>%
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  scale_y_continuous(limits = c(NA, 22))
ggsave("output/20230512-CgSCH9-phosphomimetic-mutant-timecourse-ctrl.png", width = 4.2, height = 4)
```
### Sch9-2E
In _S. cerevisiae_, Pho80/85 was shown to directly phosphorylate Sch9 and thereby regulate its lysosome localization. Here, Jinye interogate a phosphomimetic mutant in _C. glabrata_ and its interaction with _pho80∆_ and _pho81∆_ mutants.
```{r}
levels <- c(WT = "wt", `sch9::Sch9-WT-Nat` = "wt_CgSCH9-Nat", `sch9::Sch9-3E-Nat` = "CgSCH9_3E-Nat", `pho80∆` = "pho80_ko", `pho80∆ sch9::Sch9-2E` = "pho80_ko_Sch9_2E", `pho81∆` = "pho81_ko", `pho81∆ sch9::Sch9-2E` = "pho81_ko_Sch9_2E")

pi.dat.ext <- data %>% 
  filter(treat == "0Pi") %>%  
  select(Time = Group, Sample, Plate, replicate = Replicate, genotype, median) %>%
  mutate(Genotype = fct_recode(genotype,  !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)
```

Plot the time course
```{r}
genotype_color <- RColorBrewer::brewer.pal(8, "Dark2")[c(8, 7, 6, 1, 5, 4, 2)] 
names(genotype_color) <- names(levels)

pi.dat.ext %>%
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_manual(values= genotype_color, limits = names(genotype_color))
#ggsave("output/20230512-CgSCH9-phosphomimetic-mutant-timecourse-noPi.png", width = 4.2, height = 4)
```

> All comparisons except for rom2- vs WT are statistically significant at 0.05 level after Bonferroni correction (threshold: 0.05/5 = 0.01)

