---
title: "CTA1 promoter bashing"
author: "JY"
date: "2023-11-24 (updated `r Sys.Date()`)"
output: 
  html_notebook:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r}
library(tidyverse)
library(ggtext)
#library(mgcv)
library(broom)
library(cowplot)
library(ggpattern)
```

## Goal
Plot the dynamics for CTA1 promoter bashing variants under - Pi and 2 mM H2O2 treatment

## Common plotting functions
**Update 2022-11-08** 
This list is used as a shared plotting set up.
```{r}
p.timecourse <- list(
  stat_summary(fun = "mean", geom = "point", size = 3),
  stat_summary(fun.data = "mean_cl_boot", geom = "errorbar", width = 3),
  stat_smooth(aes(size = Genotype == "WT"), method = "loess", 
              formula = 'y~x', se = FALSE),
  scale_x_continuous(breaks = seq(0,240,30)),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  labs(x = "Time (min)", y = "Cta1-GFP protein level (a.u.)"),
  theme_cowplot(line_size = 0.7, font_size = 14),
  theme(legend.position=c(0.05,0.75), 
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 3), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)

mean.timecourse <- list(
  stat_summary(fun = "mean", geom = "point", size = 3),
  stat_smooth(aes(size = Genotype == "WT"), method = "loess", 
              formula = 'y~x', se = FALSE),
  scale_x_continuous(breaks = seq(0,240,30)),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  labs(x = "Time (min)", y = "Cta1-GFP protein level (a.u.)"),
  theme_cowplot(line_size = 0.7, font_size = 14),
  theme(legend.position=c(0.02,0.9),
        #legend.direction = "horizontal",
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 3), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)



scatter <- list(stat_summary(fun = "mean", geom = "point", size = 3),
                scale_y_continuous(breaks = seq(0,1.0,0.25)),
                scale_x_continuous(breaks = seq(0,1.0,0.25)),
                scale_size_manual(values = c(0.8, 1.5), guide = "none"),
                expand_limits(x = 0, y = 0),
                theme_cowplot(line_size = 0.7, font_size = 20),
                theme(legend.position=c(0.02,0.82),
                legend.text = element_text(face = 3), 
                legend.title = element_text(),
                axis.title = element_text(size = rel(1)), 
                axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1))))

bar.list <- list(
  stat_summary(fun.data = "mean_cl_boot", conf.int = .95, colour = "red", linewidth = 1, size = 0.8),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  labs(x =paste0("2mM H2O2, OL variants ", deparse1(substitute(input_tp)), " min"), y = "Cta1-GFP protein level (a.u.)"),
  theme_cowplot(line_size = 0.7, font_size = 14),
  theme(legend.position=c(0.02,0.9),
        #legend.direction = "horizontal",
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 3), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)

bar.list.no.stat <- list(
  #stat_summary(fun.data = "mean_cl_boot", conf.int = .95, colour = "red", linewidth = 1, size = 0.8),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  theme_cowplot(line_size = 0.7, font_size = 14),
  theme(legend.position=c(0.02,0.9),
        #legend.direction = "horizontal",
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 3), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)
  


```

## CTA1 induction in OL variants

#### -Pi Data
Import data and get the replicate, time and genotype info
```{r}
files <- dir("input/OL_0Pi", pattern = "d01*") # get the file names of the merged
files <- file.path("input//OL_0Pi", files)         # this appends the directory to the file names
names(files) <- c("Rep1-0Pi-Ctrl","Rep2-0Pi-Ctrl", "Rep3-0Pi-Ctrl")

tp <- c("0min",  "30min", "60min", "90min", "120min", "150min",  "180min", "210min", "240min") # ordered time points

# import and process the data to the format we want
data.ol.pi <- map_dfr(files, ~read_csv(., na = c("", "NA", "N/A"), col_types = cols()), .id = "Replicate") %>% 
  #bind_rows(.id = "Replicate") %>% 
  filter(`X Parameter` == "BL1-H", is.na(`Y Parameter`)) %>% 
  select(Replicate, Group, Sample, Count, median = `X Median`, peak = `X Peak`,
         sd = `X SD`, cv = `X %CV`, rCV = `X %rCV`) %>% 
  separate(Group, into = c('Time', 'Treatment'), sep = "-") %>% 
  mutate(Time = ordered(Time, levels = tp)) %>% 
  mutate(Sample = case_when(Sample == "CTA1-GFP-yH298" ~ "yH298-wt",
            Sample == "CTA1-GFP-yH299" ~ "yH299-wt",
            Sample == "yH343-wt" ~ "yH343-rescue",
            Sample == "yH344-wt" ~ "yH344-rescue",
            TRUE ~ Sample)) %>% 
  mutate(Replicate = gsub("\\-.*","", Replicate)) %>% # 
  separate(Sample, into = c("Strain", "genotype"), sep = "-") %>% 
  arrange(Time)
# To replace the value: ifelse() for a single test, case_when() for multiple test
# \\-: escape character "\\" used to escape the special meaning of -, instead take - as a common regex pattern. Or we can specify the - as a regex pattern within a square bracket class [-]
#.*: This part matches any sequence of characters (.* is a common regex pattern for "any character, zero or more times"). metacharacter
```


#### under -Pi
Plot the internal removal variants data(OL)
```{r}
# recode the genotype
levels <- c(`WT` = "wt", `PC`= "rescue",`IR_2.4` = "4OL", `IR_4.6` = "6OL", `IR_6.8` = "8OL", `IR_8.10` = "10OL")
levels.norescue <- c(`WT` = "wt",`IR_2.4` = "4OL", `IR_4.6` = "6OL", `IR_6.8` = "8OL", `IR_8.10` = "10OL")
G.levels <- c("WT", "PC", "IR_8.10", "IR_6.8", "IR_4.6", "IR_2.4")

pi.ol.dat <- data.ol.pi %>% 
  filter(genotype %in% c("wt", "4OL", "6OL", "8OL", "10OL","rescue")) %>%  
  select(Time, replicate = Replicate, genotype, Strain, median) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)%>% 
  mutate(genotype = factor(genotype, levels = levels)) %>% 
  mutate(Genotype = factor(Genotype, levels = G.levels))

pi.ol.dat %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels.norescue))  +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/OL_0Pi_norescue.png", width = 6, height = 8)
```
#### 2mM H2O2 Data
Import 2mM H2O2 OL data and get the replicate, time and genotype info
```{r}
files <- dir("input/OL_2mMH2O2", pattern = "d*") # get the file names of the merged
files <- file.path("input//OL_2mMH2O2", files)      # this appends the directory to the file names
names(files) <- c("Rep1-2mMH2O2","Rep2-2mMH2O2", "Rep3-2mMH2O2", "Rep4-2mMH2O2")

tp <- c("0min",  "30min", "60min", "90min", "120min", "150min",  "180min", "210min", "240min") # ordered time points

# import and process the data to the format we want
data.ol.oxi <- map_dfr(files, ~read_csv(., na = c("", "NA", "N/A"), col_types = cols()), .id = "Replicate") %>% 
  #bind_rows(.id = "Replicate") %>% 
  filter(`X Parameter` == "BL1-H", is.na(`Y Parameter`)) %>% 
  select(Replicate, Group, Sample, Count, median = `X Median`, peak = `X Peak`,
         sd = `X SD`, cv = `X %CV`, rCV = `X %rCV`) %>% 
  separate(Group, into = c('Time', 'Treatment'), sep = "-") %>% 
  mutate(Time = ordered(Time, levels = tp)) %>% 
  mutate(Sample = case_when(Sample == "CTA1-GFP-yH298" ~ "yH298-wt",
            Sample == "CTA1-GFP-yH299" ~ "yH299-wt",
            Sample == "yH343-wt" ~ "yH343-rescue",
            Sample == "yH344-wt" ~ "yH344-rescue",
            TRUE ~ Sample)) %>% 
  mutate(Replicate = gsub("\\-.*","", Replicate)) %>% # 
  separate(Sample, into = c("Strain", "genotype"), sep = "-") %>% 
  arrange(Time)
# To replace the value: ifelse() for a single test, case_when() for multiple test
# \\-: escape character "\\" used to escape the special meaning of -, instead take - as a common regex pattern. Or we can specify the - as a regex pattern within a square bracket class [-]
#.*: This part matches any sequence of characters (.* is a common regex pattern for "any character, zero or more times"). metacharacter
```


#### under 2mM H2O2
Plot the internal removal variants data(OL)
```{r}

oxi.ol.dat <- data.ol.oxi %>% 
  filter(genotype %in% c("wt", "4OL", "6OL", "8OL", "10OL","rescue")) %>%  
  select(Time, replicate = Replicate, genotype, median, Strain) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)%>% 
  mutate(genotype = factor(genotype, levels = levels))%>% 
  mutate(Genotype = factor(Genotype, levels = G.levels))


oxi.ol.dat %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  xlab("2mM H2O2, time (min)")
#ggsave("output/OL_oxi.png", width = 6, height = 8)
```
## Basal expression level of OL variants
```{r}
# Use 0min data from both H2O2 and -Pi treatment; 
data.ol <- data.ol.pi %>% bind_rows(data.ol.oxi) %>%  
  select(Time, replicate = Replicate, genotype, median, Treatment) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate) %>% 
  mutate(genotype = factor(genotype, levels = levels))%>% 
  mutate(Genotype = factor(Genotype, levels = G.levels))


data.ol %>%
  filter(!is.na(new_median), genotype != "rescue", Time == "0min") %>% 
  ggplot(aes(x = Genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  theme(legend.position="none") +
  xlab("Basal expression, 0 min")
#ggsave("output/OL_basal.png", width = 6, height = 8)

## seperately plot the basal level for 0mM Pi and 2mM H2O2
data.ol %>%
  filter(!is.na(new_median), genotype != "rescue", Time == "0min") %>% 
  ggplot(aes(x = Genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  xlab("Basal expression, 0 min") +
  facet_grid(. ~ Treatment) +
  theme(strip.background = element_rect(colour="black", fill="white", linewidth = 1, linetype="solid"), legend.position="none")
#ggsave("output/OL_seperate_basal.png", width = 9, height = 6)

## plot the 0mM Pi and 2mM H2O2 basal side by side
data.ol %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "0min") %>% 
  ggplot(aes(x = Genotype, y = new_median, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
  geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mM` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 10)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 6, col = "gray", linetype = "dashed") +
  xlab("Internal removal (IR) variants") +
  ylab("Basal exp (a.u.)") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), legend.position = "none")
ggsave("output/OL_basal_bar.png", width = 10.16, height = 2)

# calculate relative basal expression changes to wt
ir.bas.rel.pi <- data.ol %>%
          filter(!is.na(new_median), genotype != "rescue", Time == "0min", Treatment == "0Pi") %>% 
          group_by(genotype) %>% 
          mutate(new_mean_base = mean(median)) %>% 
          mutate(wt_basal = mean(.[.$Genotype == "WT",]$new_mean_base)) %>% 
          mutate(rel_base = median/wt_basal) %>% 
          mutate(Treatment = "0Pi")

ir.bas.rel.oxi <- data.ol %>% 
          filter(!is.na(new_median), genotype != "rescue", Time == "0min", Treatment == "2mM") %>% 
          group_by(genotype) %>% 
          mutate(new_mean_base = mean(median)) %>% 
          mutate(wt_basal = mean(.[.$Genotype == "WT",]$new_mean_base)) %>% 
          mutate(rel_base = median/wt_basal) %>% 
          mutate(Treatment = "2mMH2O2")

ir.bas.rel <- bind_rows(ir.bas.rel.oxi, ir.bas.rel.pi)
ir.bas.rel.save <- ir.bas.rel %>% select(Time, genotype, Genotype, rel_base)


ir.bas.rel %>% 
  filter(!is.na(rel_base), Time == "0min") %>% 
  ggplot(aes(x = Genotype, y = rel_base, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
  geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 1.5)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("Internal removal (IR) variants") +
  ylab("Basal exp") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), legend.position = "none")
ggsave("output/Ir_basal_rel_bar.png", width = 10.16, height = 2)

```
## Plateau/maximum expression Level of OL variants (V1)
The logic is cancel out the impact of basal expression level of each variants. To do so, minus the 0 min basal expression level from each variants, then plot the deduced data at all tp and the selected tp.
```{r}
# get the individual basal mean
data.ol.pi.basal <- data.ol.pi %>% filter(!is.na(median), Time == "0min") %>% group_by(genotype) %>% mutate(basal = median) %>% select(Replicate, Strain, genotype, basal)

data.ol.oxi.basal <- data.ol.oxi %>% filter(!is.na(median), Time == "0min") %>% group_by(genotype) %>% mutate(basal = median) %>% select(Replicate, Strain, genotype, basal)

# calculate the new CTA1-GFP (a.u.) by decuding the 0 min number for individual strain

pi.ol.dect <- merge(data.ol.pi, data.ol.pi.basal, by = c("Strain", "Replicate","genotype")) %>% 
  filter(genotype %in% c("wt", "4OL", "6OL", "8OL", "10OL","rescue")) %>%  
  select(Time, replicate = Replicate, genotype, median, basal) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =(median-basal)/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  mutate(genotype = factor(genotype, levels = levels)) %>% 
  mutate(Genotype = factor(Genotype, levels = G.levels)) %>% 
  arrange(new_time, genotype, replicate)

oxi.ol.dect <- merge(data.ol.oxi, data.ol.oxi.basal, by = c("Strain", "Replicate","genotype")) %>% 
  filter(genotype %in% c("wt", "4OL", "6OL", "8OL", "10OL","rescue")) %>%  
  select(Time, replicate = Replicate, genotype, median, basal) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =(median-basal)/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  mutate(genotype = factor(genotype, levels = levels)) %>% 
  mutate(Genotype = factor(Genotype, levels = G.levels)) %>% 
  arrange(new_time, genotype, replicate)

# timecourse deduct curve
pi.ol.dect %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels.norescue))  +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/OL_0Pi_deduct.png", width = 6, height = 8)

oxi.ol.dect %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels.norescue))  +
  labs(x = "2mM H2O2, Time (min)")
#ggsave("output/OL_oxi_deduct.png", width = 6, height = 8)


# single timepoint deduct curve
# - Pi: 240min
pi.ol.dect %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "240min") %>% 
  ggplot(aes(x = Genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  theme(legend.position = "none") +
  xlab("0mM Pi, 240 min")
#ggsave("output/OL_deduct_0Pi_240.png", width = 6, height = 8)


# 2mM Oxi: 90min
oxi.ol.dect %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "90min") %>% 
  ggplot(aes(x = Genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  theme(legend.position = "none") +
  xlab("2mM H2O2, 90 min")
#ggsave("output/OL_deduct_Oxi_90.png", width = 6, height = 8)

# calculate maximum plateau relative to wt
pi.ol.dect.rel <- pi.ol.dect %>% filter(Time == "240min") %>% group_by(genotype) %>% 
  mutate(new_mean_ori = mean(median)) %>% 
  mutate(new_mean_red = mean(new_median)) %>% 
  mutate(wt_ori = mean(.[.$Genotype == "WT",]$new_mean_ori)) %>% 
  mutate(wt_red = mean(.[.$Genotype == "WT",]$new_mean_red)) %>% 
  mutate(rel_ori = median/wt_ori) %>% 
  mutate(rel_red = new_median/wt_red) %>% 
  mutate(Treatment = "0Pi")
  
oxi.ol.dect.rel <- oxi.ol.dect %>% filter(Time == "90min") %>% group_by(genotype) %>% 
  mutate(new_mean_ori = mean(median)) %>% 
  mutate(new_mean_red = mean(new_median)) %>% 
  mutate(wt_ori = mean(.[.$Genotype == "WT",]$new_mean_ori)) %>% 
  mutate(wt_red = mean(.[.$Genotype == "WT",]$new_mean_red)) %>% 
  mutate(rel_ori = median/wt_ori) %>% 
  mutate(rel_red = new_median/wt_red) %>% 
  mutate(Treatment = "2mMH2O2")

ol.rel <- bind_rows(pi.ol.dect.rel, oxi.ol.dect.rel)

# plot the maximum relative to wt
ol.rel %>% 
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = Genotype, y = rel_ori, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
  geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Red", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 1.5)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("Internal removal (IR) variants") +
  ylab("Max induction (relative to wt,ori)") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"))
#ggsave("output/OL_ori_rel_max.png", width = 10.16, height = 2)



ol.rel %>% 
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = Genotype, y = rel_red, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
  geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 1.5)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("Internal removal (IR) variants") +
  ylab("Plateau") +
  guides(fill = guide_legend(nrow = 1, title = NULL), pattern = guide_legend(title = NULL)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), legend.position=c(0.8,0.9))
ggsave("output/OL_red_rel_max.png", width = 10.16, height = 2)

  
```

## Induction Rate of OL variants (V2)
The logic is get the median value of each variants at 0 minutes, then calculate the relative induction rate = Vartp/Var0min
```{r}
# calculate basal mean
data.basal_mean.pi <- data.ol %>% filter(!is.na(new_median), Time == "0min", Treatment == "0Pi") %>% group_by(Genotype) %>% mutate(basal_mean = mean(new_median)) %>% select(basal_mean, genotype)

data.basal_mean.h2o2 <- data.ol %>% filter(!is.na(new_median), Time == "0min", Treatment == "2mM") %>% group_by(Genotype) %>% mutate(basal_mean = mean(new_median)) %>% select(basal_mean, genotype)

# calculate the relative induction rate 
ind.ol.pi <- left_join(pi.ol.dat, data.basal_mean.pi, by = "genotype") %>% unique() %>% 
  mutate(ind_rate = new_median/basal_mean) %>% select(-c("Genotype.y")) %>% mutate(genotype = factor(genotype, levels = levels))
colnames(ind.ol.pi)[colnames(ind.ol.pi) == 'Genotype.x'] <- 'Genotype'

ind.ol.h2o2 <- left_join(oxi.ol.dat, data.basal_mean.h2o2, by = "genotype") %>% unique() %>% 
  mutate(ind_rate = new_median/basal_mean) %>% select(-c("Genotype.y")) %>% mutate(genotype = factor(genotype, levels = levels))
colnames(ind.ol.h2o2)[colnames(ind.ol.h2o2) == 'Genotype.x'] <- 'Genotype'

# - Pi: at 180min
ind.ol.pi %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "180min") %>% 
  ggplot(aes(x = genotype, y = ind_rate, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  ylab("Relative Induction Rate") +
  xlab("Internal Removal (IR) Variants, 0mM Pi, 180 min")
#ggsave("output/OL_ind_0Pi_180.png", width = 6, height = 8)

# calculate the raw max CTA1-GFp
ind.ol.pi %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "180min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  xlab("Internal Removal (IR) Variants, 0mM Pi, 180 min")
#ggsave("output/OL_raw_0Pi_180.png", width = 6, height = 8)


# 2mM H2O2: at 90min
ind.ol.h2o2 %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "90min") %>% 
  ggplot(aes(x = genotype, y = ind_rate, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  ylab("Relative Induction Rate") +
  xlab("Internal Removal (IR) Variants, 2mM H2O2, 90 min")
#ggsave("output/OL_ind_H2O2_90.png", width = 6, height = 8)

# calculate the raw max CTA1-GFp
ind.ol.h2o2 %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "90min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  xlab("Internal Removal (IR) Variants, 2mM H2O2, 90 min")
#ggsave("output/OL_raw_H2O2_90.png", width = 6, height = 8)

```

##### 2mM H2O2 OL timepoint plot function
```{r}
tp_GFP <- function(...){
  
  all_tp <- list(...)
  for (input_tp in all_tp) {   
  
    df_tp <- oxi.ol.dat %>% filter(new_time == input_tp) %>% mutate(genotype = factor(genotype, levels = levels))
    
    print(ggplot(df_tp, aes(x = genotype, y = new_median, fill = Genotype)) + 
    geom_point() +
    stat_summary(fun.data = "mean_cl_boot", conf.int = .95, color = "Red", linewidth = 1, size = 0.8) +
    labs(x =paste0("2mM H2O2, OL variants ", deparse1(substitute(input_tp)), " min"), y = "Cta1-GFP protein level (a.u.)") +
    theme_cowplot(line_size = 0.7, font_size = 14) +
    theme(legend.position = "none",
          axis.title = element_text(size = rel(1)), 
          axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),))
  }
}

# plot the 2mM H2O2 OL variants at 0min, 90min, 120min timepoints

tp_GFP(0,90,120,240)
  

```


**Overlapping variants**
### slope/differetiation of the loess curve
```{r}
# plot & calculate the slope/differiation changes of OL:- Pi

# check the non-duplicated strain names
check <- pi.ol.dat %>%  group_by(Genotype) %>% summarise(Strain = paste(unique(Strain), collapse = ', '))

# Can play the the genotype name to plot the diff(loess model)
test.pi <- pi.ol.dat %>% filter(Genotype == "IR_2.4") %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 

x <- 0:240
px <- predict(test.pi, newdata = x)
px1 <- diff(px)
which.max(px1) # get the x value
max(px1) # equals px1[which.max(px1)]

par(mfrow=c(1, 2))
plot(x, px, main="loess model")

plot(x[-1], px1, main="diff(loess model)")
abline(v=which.max(px1), col="red")

# get the max slope and the respective tp for each sample into a dataframe: - Pi 
pi.slope <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("slope", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(levels)) {
  tmp.pi <- pi.ol.dat %>% filter(Genotype == x)
# get the loess function
  for (y in unique(pi.ol.dat$replicate)) {
    test.pi <- tmp.pi %>% filter(replicate == y) 
    for (z in unique(test.pi$Strain)) {
      final.pi <- test.pi %>% filter(Strain == z) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2)
      x_var <- 0:240
      px <- predict(final.pi, newdata = x_var)
      # perform differentiation
      tmp <- max(diff(px))
      gt_tmp <- x
      pi.slope[row_cnt,col_cnt] <- tmp
      col_cnt = col_cnt + 1
      pi.slope[row_cnt,col_cnt] <- gt_tmp
      col_cnt = 1
      row_cnt = row_cnt + 1
    }}}


pi.slope <- pi.slope %>% 
  mutate(Genotype = factor(Genotype, levels = G.levels)) %>% 
  mutate(Treatment = "0Pi")

# plot the slope of the curve: - Pi
pi.slope %>% 
  filter(!is.na(slope), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = slope, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  theme(legend.position = "none") +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  ylab("Maximum Slope (loess fit)") +
  xlab("Internal Removal (IR) Variants, 0mM Pi")
#ggsave("output/OL_slope_0Pi.png", width = 6, height = 8)


# get the max slope and the respective tp for each sample into a dataframe: 2mM H2O2 
oxi.slope <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("slope", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(levels)) {
  tmp.oxi <- oxi.ol.dat %>% filter(Genotype == x)
# get the loess function
  for (y in unique(oxi.ol.dat$replicate)) {
    test.oxi <- tmp.oxi %>% filter(replicate == y) 
    for (z in unique(test.oxi$Strain)) {
      final.oxi <- test.oxi %>% filter(Strain == z) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2)
      x_var <- 0:240
      px <- predict(final.oxi, newdata = x_var)
      # perform differentiation
      tmp <- max(diff(px))
      gt_tmp <- x
      oxi.slope[row_cnt,col_cnt] <- tmp
      col_cnt = col_cnt + 1
      oxi.slope[row_cnt,col_cnt] <- gt_tmp
      col_cnt = 1
      row_cnt = row_cnt + 1
    }}}


oxi.slope <- oxi.slope %>% 
  mutate(Genotype = factor(Genotype, levels =G.levels)) %>% 
  mutate(Treatment = "2mMH2O2")

# plot the slope of the curve: - Pi
oxi.slope %>% 
  filter(!is.na(slope), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = slope, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  theme(legend.position= "None") +
  scale_color_viridis_d(limits = names(levels.norescue)) +
  ylab("Maximum Slope (loess fit)") +
  xlab("Internal Removal (IR) Variants, 2mM H2O2")
#ggsave("output/OL_slope_oxi.png", width = 6, height = 8)


# get the maximum slope relative to the wt
pi.slope.rel <- pi.slope %>% filter(!is.na(slope)) %>% 
  group_by(Genotype) %>% 
  mutate(mean_slope = mean(slope)) %>%
  mutate(wt_slope = mean(.[.$Genotype == "WT",]$mean_slope)) %>% 
  mutate(rel_slope = slope/wt_slope) 

oxi.slope.rel <- oxi.slope %>% filter(!is.na(slope)) %>% 
  group_by(Genotype) %>% 
  mutate(mean_slope = mean(slope)) %>%
  mutate(wt_slope = mean(.[.$Genotype == "WT",]$mean_slope)) %>% 
  mutate(rel_slope = slope/wt_slope) 

# get the combined slope
ol.slope <- bind_rows(pi.slope.rel, oxi.slope.rel)

# plot the maximum slope relative to wt
ol.slope %>% 
  filter(!is.na(rel_slope), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = rel_slope, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 1.5)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("Internal removal (IR) variants") +
  ylab("Max Slope") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), legend.position= "none")
ggsave("output/OL_slope_rel_max.png", width = 10.16, height = 2)





```

#### Get the loess curve fitting for the timecourse data
```{r}
# need names_colors
genotype_color <- RColorBrewer::brewer.pal(8, "Dark2")[c(8, 7, 6, 1, 5, 4)] 
names(genotype_color) <- names(levels)

# check for the loss fit curve
pi.ol.dat %>% ggplot(aes(x = new_time, y = new_median, color = Genotype)) + mean.timecourse + scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/loess_Ol_0Pi.png", width = 6.3, height = 8)

oxi.ol.dat %>% ggplot(aes(x = new_time, y = new_median, color = Genotype)) + mean.timecourse + scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
labs(x = "2mM H2O2, Time (min)")
#ggsave("output/loess_Ol_2mMH2O2.png", width = 6.3, height = 8)


## get AUC for - Pi data into a dataframe
pi.area <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("pi.area", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(genotype_color)) {
# calculate AUC  
madeup.pi <- pi.ol.dat %>% filter(Genotype == x) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 
f <- function(x) predict(madeup.pi,newdata=x)
# perform integration
tmp <- integrate(f,0,240)$value
gt_tmp <- x
pi.area[row_cnt,col_cnt] <- tmp
col_cnt = col_cnt + 1
pi.area[row_cnt,col_cnt] <- gt_tmp
col_cnt = 1
row_cnt = row_cnt + 1
}


# get AUC for 2mM H2O2 data
h2o2.area <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("h2o2.area", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(genotype_color)) {
# calculate AUC  
madeup.h2o2 <- oxi.ol.dat %>% filter(Genotype == x) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 
f <- function(x) predict(madeup.h2o2,newdata=x)
# perform integration
tmp <- integrate(f,0,240)$value
gt_tmp <- x
h2o2.area[row_cnt,col_cnt] <- tmp
col_cnt = col_cnt + 1
h2o2.area[row_cnt,col_cnt] <- gt_tmp
col_cnt = 1
row_cnt = row_cnt + 1
}

# combind area data
area.ol <- merge(pi.area,h2o2.area)
```

#### Check the loess fitting assumption: normality and curve fitting
```{r}

```

### regulatory information map
```{r}
# calculate the relative information retaining within each genotype
reg_info.ol <- area.ol %>% 
  mutate(pi_pcnt = pi.area/(.[.$Genotype == "WT",]$pi.area)) %>% 
  mutate(h2o2_pcnt = h2o2.area/((.[.$Genotype == "WT",]$h2o2.area)))

reg_info.ol %>% 
  ggplot(aes(x = pi_pcnt, y = h2o2_pcnt), color = Genotype) +
  scatter + 
  geom_point(size = 3, aes(color = Genotype)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "#666666") +
  labs(x = "Pi (relative to wt)", y = "H2O2 (relative to wt)") +
  scale_color_manual(values = genotype_color, limits = names(genotype_color))
#ggsave("output/Olvswt_0pivsh2o2_scatter.png", width = 6.3, height = 6.3)

# save the reg_info.ol 
write.csv(reg_info.ol, file = "output/ol_pct.csv", row.names = F)
write.csv(reg_info.ol, file = "../RS_TrunV/input/ol_pct.csv", row.names = F)
```





### Import TrunV data and get the replicate, time and genotype info
```{r}
files <- dir("input/TrunV_0Pi", pattern = "d01*") # get the file names of the merged
files <- file.path("input//TrunV_0Pi", files)         # this appends the directory to the file names
names(files) <- c("Rep1-0Pi-Ctrl","Rep2-0Pi-Ctrl", "Rep3-0Pi-Ctrl")

tp <- c("0min",  "30min", "60min", "90min", "120min", "150min",  "180min", "210min", "240min") # ordered time points

# import and process the data to the format we want
data.TrunV.pi <- map_dfr(files, ~read_csv(., na = c("", "NA", "N/A"), col_types = cols()), .id = "Replicate") %>% 
  #bind_rows(.id = "Replicate") %>% 
  filter(!is.na(median),`X Parameter` == "BL1-H", is.na(`Y Parameter`)) %>% 
  select(Replicate, Group, Sample, Count, median = `X Median`, peak = `X Peak`,
         sd = `X SD`, cv = `X %CV`, rCV = `X %rCV`) %>% 
  separate(Group, into = c('Time', 'Treatment'), sep = "-") %>% 
  mutate(Time = ordered(Time, levels = tp)) %>% 
  mutate(Sample = case_when(Sample == "CTA1-GFP-yH298" ~ "yH298-wt",
            Sample == "CTA1-GFP-yH299" ~ "yH299-wt",
            Sample == "yH343-wt" ~ "yH343-rescue",
            Sample == "yH344-wt" ~ "yH344-rescue",
            TRUE ~ Sample)) %>% 
  mutate(Replicate = gsub("\\-.*","", Replicate)) %>%  
  separate(Sample, into = c("Strain", "genotype"), sep = "-") %>% 
  filter(!is.na(median)) %>% 
  arrange(Time) 
# To replace the value: ifelse() for a single test, case_when() for multiple test
# \\-: escape character "\\" used to escape the special meaning of -, instead take - as a common regex pattern. Or we can specify the - as a regex pattern within a square bracket class [-]
#.*: This part matches any sequence of characters (.* is a common regex pattern for "any character, zero or more times"). metacharacter
```



#### Plot the truncation variants data (TrunV)
```{r}
# recode the genotype
levels <- c(`WT` = "wt", `PC`= "rescue", `IR_2.10` = "2V", `IR_4.10` = "4V", `IR_6.10` = "6V", `IR_8.10` = "8V")
levels.norescue <- c(`WT` = "wt",`IR_2.10` = "2V", `IR_4.10` = "4V", `IR_6.10` = "6V", `IR_8.10` = "8V")
G.levels <- c("WT", "PC", "IR_8.10", "IR_6.10", "IR_4.10", "IR_2.10")


pi.TrunV.dat <- data.TrunV.pi %>% 
  filter(genotype %in% c("wt", "2V", "4V", "6V", "8V","rescue")) %>%  
  select(Time, replicate = Replicate, genotype, Strain, median) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate) %>% 
  mutate(Genotype = factor(Genotype, levels = G.levels))


pi.TrunV.dat %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels.norescue), option = "plasma")  +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/TrunV_0Pi_norescue.png", width = 6, height = 8)
```
#### 2mM H2O2 Data
Import 2mM H2O2 TrunV data and get the replicate, time and genotype info
```{r}
files <- dir("input/TrunV_2mMH2O2", pattern = "d*") # get the file names of the merged
files <- file.path("input//TrunV_2mMH2O2", files)      # this appends the directory to the file names
names(files) <- c("Rep1-2mMH2O2","Rep2-2mMH2O2", "Rep3-2mMH2O2")

tp <- c("0min",  "30min", "60min", "90min", "120min", "150min",  "180min", "210min", "240min") # ordered time points

# import and process the data to the format we want
data.TrunV.oxi <- map_dfr(files, ~read_csv(., na = c("", "NA", "N/A"), col_types = cols()), .id = "Replicate") %>% 
  #bind_rows(.id = "Replicate") %>% 
  filter(`X Parameter` == "BL1-H", is.na(`Y Parameter`)) %>% 
  select(Replicate, Group, Sample, Count, median = `X Median`, peak = `X Peak`,
         sd = `X SD`, cv = `X %CV`, rCV = `X %rCV`) %>% 
  separate(Group, into = c('Time', 'Treatment'), sep = "-") %>% 
  mutate(Time = ordered(Time, levels = tp)) %>% 
  mutate(Sample = case_when(Sample == "CTA1-GFP-yH298" ~ "yH298-wt",
            Sample == "CTA1-GFP-yH299" ~ "yH299-wt",
            Sample == "yH343-wt" ~ "yH343-rescue",
            Sample == "yH344-wt" ~ "yH344-rescue",
            TRUE ~ Sample)) %>% 
  mutate(Replicate = gsub("\\-.*","", Replicate)) %>% # 
  separate(Sample, into = c("Strain", "genotype"), sep = "-") %>% 
  filter(!is.na(median)) %>% 
  arrange(Time)
# To replace the value: ifelse() for a single test, case_when() for multiple test
# \\-: escape character "\\" used to escape the special meaning of -, instead take - as a common regex pattern. Or we can specify the - as a regex pattern within a square bracket class [-]
#.*: This part matches any sequence of characters (.* is a common regex pattern for "any character, zero or more times"). metacharacter
```


#### under 2mM H2O2
Plot the Truncation variants data(TrunV)
```{r}
# use the recoded the genotype

oxi.TrunV.dat <- data.TrunV.oxi  %>% 
  filter(genotype %in% c("wt", "2V", "4V", "6V", "8V","rescue")) %>%  
  select(Time, replicate = Replicate, genotype, Strain, median) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate) %>% 
  mutate(Genotype = factor(Genotype, levels = G.levels))


oxi.TrunV.dat %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels.norescue), option = "plasma")  +
  xlab("2mM H2O2 stress, time (min)")
  #scale_y_continuous(limits = c(NA, 22))
#ggsave("output/TrunV_oxi_norescue.png", width = 6, height = 8)
```
## Basal expression level of Truncation variants
```{r}
# Use 0min data from both H2O2 and -Pi treatment; 
data.TrunV <- bind_rows(data.TrunV.oxi,data.TrunV.pi) %>%  
  select(Time, replicate = Replicate, genotype, median, Treatment) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate) %>% 
  mutate(genotype = factor(genotype, levels = levels)) %>% 
  mutate(Genotype = factor(Genotype, levels = G.levels))

# plot WT curve at - Pi and 2mM H2O2 conditions
data.TrunV %>%
  filter(!is.na(new_median), Genotype == "WT") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Treatment)) + p.timecourse +
  scale_color_manual(values = c("#8e7cc3ff","#f6b26bff"))  +
  xlab("Time (min)")
#ggsave("output/TrunV_oxi_norescue.png", width = 6, height = 8)


data.TrunV %>%
  filter(!is.na(new_median), genotype != "rescue", Time == "0min") %>% 
  ggplot(aes(x = Genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue), option = "plasma") +
  theme(legend.position="none") +
  xlab("Truncation Variants, 0 min")
#ggsave("output/TrunV_basal.png", width = 6, height = 8)

## seperately plot the basal level for 0mM Pi and 2mM H2O2
data.TrunV %>%
  filter(!is.na(new_median), genotype != "rescue", Time == "0min") %>% 
  ggplot(aes(x = Genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  scale_color_viridis_d(limits = names(levels.norescue), option = "plasma") +
  theme(legend.position=c(0.85,0.9)) +
  xlab("Truncation Variants, 0 min") +
  facet_grid(. ~ Treatment) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), legend.position = "none")
#ggsave("output/TrunV_seperate_basal.png", width = 6, height = 8)


# calculate relative basal expression changes to wt
TrunV.bas.rel.pi <- data.TrunV %>%
          filter(!is.na(new_median), genotype != "rescue", Time == "0min", Treatment == "0Pi") %>% 
          group_by(genotype) %>% 
          mutate(new_mean_base = mean(median)) %>% 
          mutate(wt_basal = mean(.[.$Genotype == "WT",]$new_mean_base)) %>% 
          mutate(rel_base = median/wt_basal) %>% 
          mutate(Treatment = "0Pi")

TrunV.bas.rel.oxi <- data.TrunV %>% 
          filter(!is.na(new_median), genotype != "rescue", Time == "0min", Treatment == "H2O2") %>% 
          group_by(genotype) %>% 
          mutate(new_mean_base = mean(median)) %>% 
          mutate(wt_basal = mean(.[.$Genotype == "WT",]$new_mean_base)) %>% 
          mutate(rel_base = median/wt_basal) %>% 
          mutate(Treatment = "2mMH2O2")

TrunV.bas.rel <- bind_rows(TrunV.bas.rel.oxi, TrunV.bas.rel.pi)
TrunV.bas.rel.save <- TrunV.bas.rel %>% select(Time, genotype, Genotype, rel_base)


TrunV.bas.rel %>% 
  filter(!is.na(rel_base), Time == "0min") %>% 
  ggplot(aes(x = Genotype, y = rel_base, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
  geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 1.5)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("Internal swap (IS) variants") +
  ylab("Basal exp (a.u.)") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"))
#ggsave("output/TrunV_basal_rel_bar.png", width = 10.16, height = 2)

```



## Plateau/maximum expression Level of Truncation variants (V1)
The logic is cancel out the impact of basal expression level of each variants. To do so, minus the 0 min basal expression level from each variants, then plot the deduced data at all tp and the selected tp.
```{r}
# get the individual basal mean
data.TrunV.pi.basal <- data.TrunV.pi %>% filter(!is.na(median), Time == "0min") %>% group_by(genotype) %>% mutate(basal = median) %>% select(Replicate, Strain, genotype, basal)

data.TrunV.oxi.basal <- data.TrunV.oxi %>% filter(!is.na(median), Time == "0min") %>% group_by(genotype) %>% mutate(basal = median) %>% select(Replicate, Strain, genotype, basal)


pi.TrunV.dect <- merge(data.TrunV.pi, data.TrunV.pi.basal, by = c("Strain", "Replicate","genotype")) %>% 
  filter(genotype %in% c("wt", "2V", "4V", "6V", "8V", "rescue")) %>%  
  select(Time, replicate = Replicate, genotype, median, basal) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =(median-basal)/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  mutate(genotype = factor(genotype, levels = levels)) %>% 
  arrange(new_time, genotype, replicate)

oxi.TrunV.dect <- merge(data.TrunV.oxi, data.TrunV.oxi.basal, by = c("Strain", "Replicate","genotype")) %>% 
  filter(genotype %in% c("wt", "2V", "4V", "6V", "8V", "rescue")) %>%  
  select(Time, replicate = Replicate, genotype, median, basal) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =(median-basal)/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  mutate(genotype = factor(genotype, levels = levels)) %>% 
  arrange(new_time, genotype, replicate)

# timecourse deduct curve
pi.TrunV.dect %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels.norescue), option = "plasma")  +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/TrunV_0Pi_deduct.png", width = 6, height = 8)

oxi.TrunV.dect %>%
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_viridis_d(limits = names(levels.norescue), option = "plasma")  +
  labs(x = "2mM H2O2, Time (min)")
#ggsave("output/TrunV_oxi_deduct.png", width = 6, height = 8)


# single timepoint deduct curve
# - Pi: 240min
pi.TrunV.dect %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "240min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  theme(legend.position=c(0.85,0.9)) +
  scale_color_viridis_d(limits = names(levels.norescue), option = "plasma") +
  xlab("Truncation Variants, 0mM Pi, 240 min")
#ggsave("output/TrunV_deduct_0Pi_240.png", width = 6, height = 8)

# 2mM Oxi: 90min
oxi.TrunV.dect %>% 
  filter(!is.na(new_median), genotype != "rescue", Time == "90min") %>% 
  ggplot(aes(x = genotype, y = new_median, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  theme(legend.position=c(0.85,0.9)) +
  scale_color_viridis_d(limits = names(levels.norescue), option = "plasma") +
  xlab("Truncation Variants, 2mM H2O2, 90 min")
#ggsave("output/TrunV_deduct_Oxi_90.png", width = 6, height = 8)

# calculate maximum plateau relative to wt
pi.TrunV.dect.rel <- pi.TrunV.dect %>% filter(Time == "240min") %>% group_by(genotype) %>% 
  mutate(new_mean_ori = mean(median)) %>% 
  mutate(new_mean_red = mean(new_median)) %>% 
  mutate(wt_ori = mean(.[.$Genotype == "WT",]$new_mean_ori)) %>% 
  mutate(wt_red = mean(.[.$Genotype == "WT",]$new_mean_red)) %>% 
  mutate(rel_ori = median/wt_ori) %>% 
  mutate(rel_red = new_median/wt_red) %>% 
  mutate(Treatment = "0Pi")
  
oxi.TrunV.dect.rel <- oxi.TrunV.dect %>% filter(Time == "90min") %>% group_by(genotype) %>% 
  mutate(new_mean_ori = mean(median)) %>% 
  mutate(new_mean_red = mean(new_median)) %>% 
  mutate(wt_ori = mean(.[.$Genotype == "WT",]$new_mean_ori)) %>% 
  mutate(wt_red = mean(.[.$Genotype == "WT",]$new_mean_red)) %>% 
  mutate(rel_ori = median/wt_ori) %>% 
  mutate(rel_red = new_median/wt_red) %>% 
  mutate(Treatment = "2mMH2O2")

TrunV.rel <- bind_rows(pi.TrunV.dect.rel, oxi.TrunV.dect.rel) %>% mutate(Genotype = factor(Genotype, levels = G.levels))

# plot the maximum relative to wt
TrunV.rel %>% 
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = Genotype, y = rel_ori, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
  geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Red", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 1.5)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("Internal removal (IR) variants") +
  ylab("Max induction (relative to wt,ori)") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"))
#ggsave("output/TrunV_ori_rel_max.png", width = 10.16, height = 2)



TrunV.rel %>% 
  filter(!is.na(new_median), genotype != "rescue") %>% 
  ggplot(aes(x = Genotype, y = rel_red, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
  geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Red", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 1.5)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("Internal removal (IR) variants") +
  ylab("Plateau") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), legend.position=c(0.8,0.9))
#ggsave("output/TrunV_red_rel_max.png", width = 10.16, height = 2)

```
### test epistasis effect between all IR variants
# Basal
```{r}
# combine IS and IR variants for epistasis test
rs.bas.rel <- read.csv("input/rs_bas_rel.csv")
bas.rel <- bind_rows(ir.bas.rel, TrunV.bas.rel) %>% select(Time, genotype, Genotype, rel_base, Treatment) %>% bind_rows(.,rs.bas.rel) %>% mutate(beta_2.4 = 1, beta_4.6 = 1, beta_6.8 = 1, beta_8.10 = 1)

bas.rel$beta_2.4 <- with(bas.rel, ifelse(Genotype == "IR_2.4" | Genotype == "IR_2.10" | Genotype == "IS_2.4" |
                                         Genotype == "IS_2.6" | Genotype == "IS_2.8" | Genotype == "IS_2.10", 0, 1))
bas.rel$beta_4.6 <- with(bas.rel, ifelse(Genotype == "IR_4.6" | Genotype == "IR_2.10"| Genotype == "IR_4.10" |
                                         Genotype == "IS_2.6" | Genotype == "IS_2.8"| Genotype == "IS_2.10", 0, 1))
bas.rel$beta_6.8 <- with(bas.rel, ifelse(Genotype == "IR_6.8" | Genotype == "IR_2.10"| Genotype == "IR_4.10"| 
                                         Genotype == "IR_6.10"| Genotype == "IS_2.8"| Genotype == "IS_2.10", 0, 1))
bas.rel$beta_8.10 <- with(bas.rel, ifelse(Genotype == "IR_8.10" | Genotype == "IR_2.10"| Genotype == "IR_4.10"| 
                                         Genotype == "IR_6.10" | Genotype == "IS_2.10", 0, 1))

bas.rel.pi <- bas.rel%>% filter(Genotype != "PC", Treatment == "0Pi")
bas.rel.oxi <- bas.rel %>% filter(Genotype != "PC", Treatment == "2mMH2O2")



# variable selection for the lm
# - Pi:
full.model.pi <- lm(rel_base ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                 beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = bas.rel.pi)
base.model.pi <- lm(rel_base ~ 1, data = bas.rel.pi)

# 2mM H2O2:
full.model.oxi <- lm(rel_base ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                 beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = bas.rel.oxi)
base.model.oxi <- lm(rel_base ~ 1, data = bas.rel.oxi)

# all treatment:
full.model <- lm(rel_base ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = bas.rel)
base.model <- lm(rel_base ~ 1, data = bas.rel)

#choose a model by AIC in a stepwise algorithm
# forward
step(base.model.pi, scope=list(upper=full.model.pi,lower=~1),direction="forward")
step(base.model.oxi, scope = list(upper = full.model.oxi, lower =~1), direction = "forward")
step(base.model, scope = list(upper = full.model, lower = ~1), direction = "forward")

# backward: all prefers full model
step(full.model.pi, direction="backward") 
step(full.model.oxi, direction = "backward") 
step(full.model, direction = "backward")

#the best forward stepwise selected model:
# - Pi:
fit.pi.fwd <- lm(rel_base ~  beta_8.10 + beta_2.4 + beta_6.8 + beta_8.10:beta_6.8, data = bas.rel.pi)
pi.fwd <- glance(fit.pi.fwd)
# this model has an AIC = -74, BIC = -57, both are larger than full model,  R square adj = 0.76

# 2mM h2o2:
fit.oxi.fwd <- lm(rel_base ~  beta_8.10 + beta_2.4 + beta_6.8 + beta_8.10:beta_6.8, data = bas.rel.oxi)
oxi.fwd <- glance(fit.oxi.fwd)#  AIC = -102, BIC = -85, R square adj = 0.77

# two treatments:
fit.fwd <- lm(rel_base ~ beta_8.10 + beta_2.4 + beta_6.8 + beta_8.10:beta_6.8, data = bas.rel)
fwd <- glance(fit.fwd) # AIC = -185, BIC = -164, R square adj = 0.77



# full model
# - Pi:
fit.pi <- bas.rel.pi %>% lm(rel_base ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)
round(summary(fit.pi)$coef, 3)
pi.full <- glance(fit.pi) #  AIC = -98, BIC = -73, R square adj = 0.8

# 2mM H2O2:
fit.oxi <- bas.rel.oxi %>% lm(rel_base ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)
round(summary(fit.oxi)$coef, 3)
oxi.full <- glance(fit.oxi) #  AIC = -129, BIC = -103, R square adj = 0.82

# combine - Pi and H2O2
fit.all <- bas.rel %>% lm(rel_base ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)
round(summary(fit.all)$coef, 3)
full <- glance(fit.all) #  AIC = -241, BIC = -209, R square adj = 0.81


## OL+TrunV+WT
fit.ir <- bas.rel %>% filter(!(Genotype %in% c("IS_2.10", "IS_2.8", "IS_2.6", "IS_2.4"))) %>% 
                      lm(rel_base ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 + 
                           beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)
round(summary(fit.ir)$coef, 3)

## RS+OL+WT
fit.rs <- bas.rel %>% filter(!(genotype %in% c("2V", "4V", "6V", "8V"))) %>% 
                      lm(rel_base ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 + 
                           beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)
round(summary(fit.rs)$coef, 3)


```

# Plateau
```{r}
# combine IS and IR variants for epistasis test
rs.plateau <- read.csv("input/rs_plateau.csv")
ir.plateau <- bind_rows(ol.rel, TrunV.rel) %>% select(Time, Genotype, genotype, Treatment, rel_ori, rel_red)
plateau <- bind_rows(ir.plateau, rs.plateau) %>% mutate(beta_2.4 = 1, beta_4.6 = 1, beta_6.8 = 1, beta_8.10 = 1)

plateau$beta_2.4 <- with(plateau, ifelse(Genotype == "IR_2.4" | Genotype == "IR_2.10" | Genotype == "IS_2.4" |
                                         Genotype == "IS_2.6" | Genotype == "IS_2.8" | Genotype == "IS_2.10", 0, 1))
plateau$beta_4.6 <- with(plateau, ifelse(Genotype == "IR_4.6" | Genotype == "IR_2.10"| Genotype == "IR_4.10" |
                                         Genotype == "IS_2.6" | Genotype == "IS_2.8"| Genotype == "IS_2.10", 0, 1))
plateau$beta_6.8 <- with(plateau, ifelse(Genotype == "IR_6.8" | Genotype == "IR_2.10"| Genotype == "IR_4.10"| 
                                         Genotype == "IR_6.10"| Genotype == "IS_2.8"| Genotype == "IS_2.10", 0, 1))
plateau$beta_8.10 <- with(plateau, ifelse(Genotype == "IR_8.10" | Genotype == "IR_2.10"| Genotype == "IR_4.10"| 
                                         Genotype == "IR_6.10" | Genotype == "IS_2.10", 0, 1))


plateau.pi <- plateau %>% filter(Genotype != "PC", Treatment == "0Pi")
plateau.oxi <- plateau %>% filter(Genotype != "PC", Treatment == "2mMH2O2")


# variable selection for the lm (with reduction)
# - Pi:
full.model.pi <- lm(rel_red ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = plateau.pi)
base.model.pi <- lm(rel_red ~ 1, data = plateau.pi)

# 2mM H2O2:
full.model.oxi <- lm(rel_red ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                 beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = plateau.oxi)
base.model.oxi <- lm(rel_red ~ 1, data = plateau.oxi)

#choose a model by AIC in a stepwise algorithm
# forward
step(base.model.pi, scope=list(upper=full.model.pi,lower=~1),direction="forward")
step(base.model.oxi, scope = list(upper = full.model.oxi, lower =~1), direction = "forward")

# backward: all prefers full model
step(full.model.pi, direction="backward") 
step(full.model.oxi, direction = "backward") 

#the best forward and backward stepwise selected model: (better than full model)
# - Pi: (both fwd and bwd)
fit.pi.fwd <- lm(rel_red ~   beta_2.4 + beta_6.8 + beta_4.6 + beta_8.10 +beta_6.8:beta_8.10, data = plateau.pi)
round(summary(fit.pi.fwd)$coef, 5)
pi.fwd <- glance(fit.pi.fwd) # AIC = -162, BIC = -142,  R square adj = 0.8932

# 2mM h2o2:(both fwd and bwd)
fit.oxi.fwd <- lm(rel_red ~   beta_2.4 + beta_8.10 + beta_6.8 + beta_4.6 + beta_2.4:beta_4.6, data = plateau.oxi)
round(summary(fit.oxi.fwd)$coef, 5)
oxi.fwd <- glance(fit.oxi.fwd)#  AIC = -203, BIC = -183, R square adj = 0.8886 



# lm() fit
# with deduction
# - Pi:
fit.pi <- plateau.pi %>% lm(rel_red ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)
#round(summary(fit.pi)$coef, 5)
pi <- glance(fit.pi) # AIC = -160, BIC = -135,  R square adj = 0.8881

# 2mM H2O2:
fit.oxi <- plateau.oxi %>% lm(rel_red ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)
#round(summary(fit.oxi)$coef, 5)
oxi <- glance(fit.oxi) # AIC = -200, BIC = -174, R square adj = 0.8875


# original data w/o basal deduction
fit.pi <- plateau.pi %>% lm(rel_ori ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)
round(summary(fit.pi)$coef, 3)


fit.oxi <- plateau.oxi %>% lm(rel_ori ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)
round(summary(fit.oxi)$coef, 3)


```

```{r}
# Method 0: combine all IR variants for epistasis test
IR.epi <- bind_rows(ol.rel, TrunV.rel) %>% select(Genotype, Treatment, median, median_adj = new_median, genotype) %>% 
  mutate(median = median/1000, beta_2.4 = 1, beta_4.6 = 1, beta_6.8 = 1, beta_8.10 = 1, TrunV_variable = 0)

# set up contrast matrix
IR.epi$beta_2.4 <- with(IR.epi, ifelse(Genotype == "IR_2.4" | Genotype == "IR_2.10", 0, 1))
IR.epi$beta_4.6 <- with(IR.epi, ifelse(Genotype == "IR_4.6" | Genotype == "IR_2.10"| Genotype == "IR_4.10", 0, 1))
IR.epi$beta_6.8 <- with(IR.epi, ifelse(Genotype == "IR_6.8" | Genotype == "IR_2.10"| Genotype == "IR_4.10"| 
                                       Genotype == "IR_6.10", 0, 1))
IR.epi$beta_8.10 <- with(IR.epi, ifelse(Genotype == "IR_8.10" | Genotype == "IR_2.10"| Genotype == "IR_4.10"| 
                                       Genotype == "IR_6.10", 0, 1))
IR.epi$TrunV_variable <- with(IR.epi, ifelse(genotype == "2V" | genotype == "4V"| genotype == "6V"| 
                                       genotype == "8V", 1, 0))

IR.epi.pi <- IR.epi %>% filter(Genotype != "PC", Treatment == "0Pi")
IR.epi.oxi <- IR.epi %>% filter(Genotype != "PC", Treatment == "2mMH2O2")

# lm() fit
# original data withoud basal deduction
fit.pi <- IR.epi.pi %>% lm(median ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 + TrunV_variable +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)

round(summary(fit.pi)$coef, 3)

fit.oxi <- IR.epi.oxi %>% lm(median ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10  + TrunV_variable +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)

round(summary(fit.oxi)$coef, 3)

# data deduced basal deduction
fit.pi <- IR.epi.pi %>% lm(median_adj ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10  + TrunV_variable +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)

round(summary(fit.pi)$coef, 3)

fit.oxi <- IR.epi.oxi %>% lm(median_adj ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10  + TrunV_variable +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = .)

round(summary(fit.oxi)$coef, 3)

# Conclusion: 
# 1. absolute data revealed that no epitasis effect for - Pi (only additive effect); for oxidative stress epistatic effect identifed between all every 200 bps CRMs

# 2. Epistasis effect on Induction level: absolute data (basal reduced) revealed epitatic effect between 24 to 46, and 68 to 80 regardless of stress; epistatic effect between 46 to 68 only in H2O2 treatment

# 3. Epistasis effect on basal expression level?

# Note for contrast matrix: set -1 (IRs) vs 0 (WT) and set 0(IRs) vs 1 (WT) give the exact same result.
```

# epitasis test between 600 - 800 bps and 800 - 1kb bps region
```{r}
# Method I: get IR_6.10, IR_6.8, IR_8.10 and WT for epistasis test
IR_6810.pi <- ol.rel %>% filter(Genotype %in% c("IR_6.8", "IR_8.10", "WT"), Treatment == "0Pi", Time == "240min")

IR_6810.oxi <- ol.rel %>% filter(Genotype %in% c("IR_6.8", "IR_8.10", "WT"), Treatment == "2mMH2O2", Time == "90min")

IR_610.pi <- TrunV.rel %>% filter(Genotype %in% c("IR_6.10", "IR_8.10", "WT"), Treatment == "0Pi", Time == "240min")
IR_610.oxi <- TrunV.rel %>% filter(Genotype %in% c("IR_6.10", "IR_8.10", "WT"), Treatment == "2mMH2O2", Time == "90min")

epi.pi <- bind_rows(IR_6810.pi, IR_610.pi)
epi.oxi <- bind_rows(IR_6810.oxi, IR_610.oxi)

epi.pi <- epi.pi %>% select(Genotype, Treatment, median, median_adj = new_median) %>% 
  mutate(median = median/1000)
epi.oxi <- epi.oxi %>% select(Genotype, Treatment, median, median_adj = new_median) %>% 
  mutate(median = median/1000)

# set up contrast matrix
epi <- bind_rows(epi.pi, epi.oxi) %>% mutate(beta_6.8 = 0, beta_8.10 = 0)
epi$beta_6.8 <- with(epi, ifelse(Genotype == "IR_6.8" | Genotype == "IR_6.10", -1, 0))
epi$beta_8.10 <- with(epi, ifelse(Genotype == "IR_8.10" | Genotype == "IR_6.10", -1, 0))

# make the statistical model
## original data (basal expression not deduced)
fit.ori.pi <- epi %>% filter(Treatment == "0Pi") %>% lm(median ~ beta_6.8 + beta_8.10 + 
                      beta_6.8:beta_8.10,
                    data = .)
round(summary(fit.ori.pi)$coef, 3)

fit.ori.oxi <- epi %>% filter(Treatment == "2mMH2O2") %>% lm(median ~ beta_6.8 + beta_8.10 +
                                                               beta_6.8:beta_8.10, data = .)
round(summary(fit.ori.oxi)$coef, 3)

## deduced data
fit.adj.pi <- epi %>% filter(Treatment == "0Pi") %>% lm(median_adj ~ beta_6.8 + beta_8.10 +
                beta_6.8:beta_8.10,
              data = .)
round(summary(fit.adj.pi)$coef, 3)

fit.adj.oxi <- epi %>% filter(Treatment == "2mMH2O2") %>% lm(median_adj ~ beta_6.8 + beta_8.10 +
                                                               beta_6.8:beta_8.10, data = .)
round(summary(fit.adj.oxi)$coef, 3)

# Conclusion: (Without add in 8V data, 8V does not agree perfectly with 10OL) for the plaeteau, regardless of treatment and basal expression, 800-1000 bps and 600 to 800 bps has no significant interaction; with 8V and 10OL, they do have an epistasis effect.

#

```

### slope/differetiation of the loess curve
```{r}
# plot & calculate the slope/differiation changes of OL:- Pi
# check the non-duplicated strain names
check.TrunV <- pi.TrunV.dat %>%  group_by(Genotype) %>% summarise(Strain = paste(unique(Strain), collapse = ', '))

# Can play the the genotype name to plot the diff(loess model)
test.pi <- pi.TrunV.dat %>% filter(Genotype == "IR_4.10") %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 

x <- 0:240
px <- predict(test.pi, newdata = x)
px1 <- diff(px)
which.max(px1) # get the x value
max(px1) # equals px1[which.max(px1)]

par(mfrow=c(1, 2))
plot(x, px, main="loess model")

plot(x[-1], px1, main="diff(loess model)")
abline(v=which.max(px1), col="red")

# get the max slope and the respective tp for each sample into a dataframe: - Pi 
pi.TrunV.slope <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("slope", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(levels)) {
  tmp.pi <- pi.TrunV.dat %>% filter(Genotype == x)
# get the loess function
  for (y in unique(pi.TrunV.dat$replicate)) {
    test.pi <- tmp.pi %>% filter(replicate == y) 
    for (z in unique(test.pi$Strain)) {
      final.pi <- test.pi %>% filter(Strain == z) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2)
      x_var <- 0:240
      px <- predict(final.pi, newdata = x_var)
      # perform differentiation
      tmp <- max(diff(px))
      gt_tmp <- x
      pi.TrunV.slope[row_cnt,col_cnt] <- tmp
      col_cnt = col_cnt + 1
      pi.TrunV.slope[row_cnt,col_cnt] <- gt_tmp
      col_cnt = 1
      row_cnt = row_cnt + 1
    }}}


pi.TrunV.slope <- pi.TrunV.slope %>% 
  mutate(Genotype = factor(Genotype, levels =G.levels)) %>% 
  mutate(Treatment = "0Pi") 

# plot the slope of the curve: - Pi
pi.TrunV.slope %>% 
  filter(!is.na(slope), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = slope, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  theme(legend.position="none") +
  scale_color_viridis_d(limits = names(levels.norescue), option = "plasma") +
  theme(legend.position=c(0.85,0.9)) +
  ylab("Maximum Slope (loess fit)") +
  xlab("Truncation Variants, 0mM Pi")
#ggsave("output/TrunV_slope_0Pi.png", width = 6, height = 8)


# get the max slope and the respective tp for each sample into a dataframe: 2mM H2O2 
oxi.TrunV.slope <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("slope", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(levels)) {
  tmp.oxi <- oxi.TrunV.dat %>% filter(Genotype == x)
# get the loess function
  for (y in unique(oxi.TrunV.dat$replicate)) {
    test.oxi <- tmp.oxi %>% filter(replicate == y) 
    for (z in unique(test.oxi$Strain)) {
      final.oxi <- test.oxi %>% filter(Strain == z) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2)
      x_var <- 0:240
      px <- predict(final.oxi, newdata = x_var)
      # perform differentiation
      tmp <- max(diff(px))
      gt_tmp <- x
      oxi.TrunV.slope[row_cnt,col_cnt] <- tmp
      col_cnt = col_cnt + 1
      oxi.TrunV.slope[row_cnt,col_cnt] <- gt_tmp
      col_cnt = 1
      row_cnt = row_cnt + 1
    }}}


oxi.TrunV.slope <- oxi.TrunV.slope %>% 
  mutate(Genotype = factor(Genotype, levels =G.levels)) %>% 
  mutate(Treatment = "2mMH2O2")

# plot the slope of the curve: - Pi
oxi.TrunV.slope %>% 
  filter(!is.na(slope), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = slope, color = Genotype)) + bar.list +
  geom_boxplot() +
  stat_summary(fun.data = "mean_cl_boot", color = "Red", linewidth = 1, size = 0.8) +
  geom_jitter(width = 0.2) +
  theme(legend.position="none") +
  scale_color_viridis_d(limits = names(levels.norescue), option = "plasma") +
  ylab("Maximum Slope (loess fit)") +
  xlab("Truncation Variants, 2mM H2O2")
#ggsave("output/TrunV_slope_oxi.png", width = 6, height = 8)


# get the maximum slope relative to the wt
pi.slope.rel <- pi.TrunV.slope %>% filter(!is.na(slope)) %>% 
  group_by(Genotype) %>% 
  mutate(mean_slope = mean(slope)) %>%
  mutate(wt_slope = mean(.[.$Genotype == "WT",]$mean_slope)) %>% 
  mutate(rel_slope = slope/wt_slope) 

oxi.slope.rel <- oxi.TrunV.slope %>% filter(!is.na(slope)) %>% 
  group_by(Genotype) %>% 
  mutate(mean_slope = mean(slope)) %>%
  mutate(wt_slope = mean(.[.$Genotype == "WT",]$mean_slope)) %>% 
  mutate(rel_slope = slope/wt_slope) 

# get the combined slope
TrunV.slope <- bind_rows(pi.slope.rel, oxi.slope.rel)

# plot the maximum slope relative to wt
TrunV.slope %>% 
  filter(!is.na(rel_slope), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = rel_slope, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(0, 1.5)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("Internal removal (IR) variants") +
  ylab("Max Slope") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), legend.position= "none")
ggsave("output/TrunV_slope_rel_max.png", width = 10.16, height = 2)

```

#statstical test for max slope
```{r}
rs.slope <- read.csv("input/rs_slope_rel.csv")
slope.rel <- bind_rows(TrunV.slope, ol.slope) %>% select(slope, rel_slope, Genotype, Treatment) %>% bind_rows(.,rs.slope) %>% 
            mutate(beta_2.4 = 1, beta_4.6 = 1, beta_6.8 = 1, beta_8.10 = 1)

slope.rel$beta_2.4 <- with(slope.rel, ifelse(Genotype == "IR_2.4" | Genotype == "IR_2.10" | Genotype == "IS_2.4" |
                                         Genotype == "IS_2.6" | Genotype == "IS_2.8" | Genotype == "IS_2.10", 0, 1))
slope.rel$beta_4.6 <- with(slope.rel, ifelse(Genotype == "IR_4.6" | Genotype == "IR_2.10"| Genotype == "IR_4.10" |
                                         Genotype == "IS_2.6" | Genotype == "IS_2.8"| Genotype == "IS_2.10", 0, 1))
slope.rel$beta_6.8 <- with(slope.rel, ifelse(Genotype == "IR_6.8" | Genotype == "IR_2.10"| Genotype == "IR_4.10"| 
                                         Genotype == "IR_6.10"| Genotype == "IS_2.8"| Genotype == "IS_2.10", 0, 1))
slope.rel$beta_8.10 <- with(slope.rel, ifelse(Genotype == "IR_8.10" | Genotype == "IR_2.10"| Genotype == "IR_4.10"| 
                                         Genotype == "IR_6.10" | Genotype == "IS_2.10", 0, 1))


slope.rel.pi <- slope.rel %>% filter(Genotype != "PC", Treatment == "0Pi")
slope.rel.oxi <- slope.rel %>% filter(Genotype != "PC", Treatment == "2mMH2O2")



# variable selection for the lm (with reduction)
# - Pi:
full.model.pi <- lm(rel_slope ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = slope.rel.pi)
base.model.pi <- lm(rel_slope ~ 1, data = slope.rel.pi)

# 2mM H2O2:
full.model.oxi <- lm(rel_slope ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = slope.rel.oxi)
base.model.oxi <- lm(rel_slope ~ 1, data = slope.rel.oxi)

#choose a model by AIC in a stepwise algorithm
# forward
step(base.model.pi, scope=list(upper=full.model.pi,lower=~1),direction="forward")
step(base.model.oxi, scope = list(upper = full.model.oxi, lower =~1), direction = "forward")

# backward: all prefers full model
step(full.model.pi, direction="backward") 
step(full.model.oxi, direction = "backward") 

#the best forward and backward stepwise selected model: (better than full model)
# - Pi: (both fwd and bwd)
fit.pi.fwd <-   lm(rel_slope ~  beta_6.8 + beta_2.4 + beta_4.6 + beta_8.10 + beta_6.8:beta_4.6 +
                               beta_6.8:beta_8.10, data = slope.rel.pi)
round(summary(fit.pi.fwd)$coef, 5)
pi.fwd <- glance(fit.pi.fwd) # AIC = -221, BIC = -199 , R square adj = 0.9148

# 2mM h2o2:(both fwd and bwd)
fit.oxi.fwd <- lm(rel_slope ~   beta_2.4 + beta_8.10 + beta_6.8 + beta_4.6 + beta_2.4:beta_4.6, data = slope.rel.oxi)
round(summary(fit.oxi.fwd)$coef, 5)
oxi.fwd <- glance(fit.oxi.fwd) # AIC = -133, BIC = -113 , R square adj = 0.8228

# full model
# - Pi:
fit.pi <- lm(rel_slope ~  beta_2.4 + beta_6.8 + beta_4.6 + beta_8.10 + 
               beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = slope.rel.pi)
#round(summary(fit.pi)$coef, 3)
pi <- glance(fit.pi) # AIC = -219, BIC = -194 , R square adj = 0.9143


# 2mM H2O2:
fit.oxi <- lm(rel_slope ~ beta_2.4 + beta_4.6 + beta_6.8 + beta_8.10 +
                             beta_2.4:beta_4.6 + beta_4.6:beta_6.8 + beta_6.8:beta_8.10, data = slope.rel.oxi)
#round(summary(fit.oxi)$coef, 3)
oxi <- glance(fit.oxi) # AIC = -129, BIC = -103 , R square adj = 0.8203
```
#Plot regulatory information loss with all variants
```{r}
#new.levels <- c("WT", "IS_2.4","IR_2.4","IR_4.6","IR_6.8","IR_8.10")
new.levels <- c("WT", "IR_8.10", "IR_6.8", "IR_4.6", "IR_2.4", "IS_2.4")

# new.levels
new.plateau <- plateau %>% filter(Genotype %in% c("WT", "IS_2.4","IR_2.4","IR_4.6","IR_6.8","IR_8.10")) %>% 
  select(Genotype, Time, genotype, rel_ori,rel_red, Treatment) %>% 
  mutate(loss_ori = 1 - rel_ori, loss_red = 1 - rel_red) %>% 
  mutate(Genotype = factor(Genotype, levels = new.levels))

new.slope <- slope.rel %>% filter(Genotype %in% c("WT", "IS_2.4","IR_2.4","IR_4.6","IR_6.8","IR_8.10")) %>% 
  select(Genotype, rel_slope, Treatment) %>% 
  mutate(loss_slope = 1 - rel_slope) %>% 
  mutate(Genotype = factor(Genotype, levels = new.levels))

new.bas <- bas.rel %>% filter(Genotype %in% c("WT", "IS_2.4","IR_2.4","IR_4.6","IR_6.8","IR_8.10")) %>% 
  select(Genotype, Time, rel_base, Treatment,genotype) %>% 
  mutate(loss_base = 1 - rel_base) %>% 
  mutate(Genotype = factor(Genotype, levels = new.levels))
      
# plot regulatory infomation loss
new.plateau %>% 
  filter(!is.na(loss_red), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = loss_red, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(-0.25, 1.0)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("promoter bashing variants") +
  ylab("Plateau loss \n (Relative to WT)") +
  guides(fill = guide_legend(nrow = 1, title = NULL), pattern = guide_legend(title = NULL)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), 
        legend.position= c(0.02, 0.9),
        axis.title.x=element_blank())
#ggsave("output/plateau_loss.png", width = 7.2, height = 2)

new.slope %>% 
  filter(!is.na(loss_slope), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = loss_slope, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(-0.25, 1.0)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("promoter bashing variants") +
  ylab("Max slope loss \n (Relative to WT)") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), 
        legend.position= "none",
        axis.title.x=element_blank())
#ggsave("output/slope_loss.png", width = 7.2, height = 2)

new.bas %>% 
  filter(!is.na(loss_base), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = loss_base, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(-0.5, 1.0)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("promoter bashing variants") +
  ylab("Basal exp loss \n (Relative to WT)") +
  guides(fill = guide_legend(nrow = 1, title = NULL), pattern = guide_legend(title = NULL)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), 
        legend.position= c(0.02, 0.9),
        axis.title.x=element_blank())
#ggsave("output/base_loss.png", width = 10.16, height = 2)
```

# plot CRM4.6 related three features relative to WT
```{R}
#CRM4.6
CRM46.levels <- c("WT","IS_2.4","IS_2.6","IR_4.10","IR_6.10")

## Plateau
CRM46.plateau <- plateau %>% filter(Genotype %in% CRM46.levels) %>% 
                 select(Genotype,Time,genotype,rel_ori,rel_red,Treatment) %>% 
                 mutate(loss_ori = 1 - rel_ori, loss_red = 1 - rel_red, Genotype = factor(Genotype, levels = CRM46.levels)) 

## Slope
CRM46.slope <- slope.rel %>% filter(Genotype %in% CRM46.levels) %>% 
               select(Genotype, rel_slope, Treatment) %>% 
               mutate(loss_slope = 1 - rel_slope, Genotype = factor(Genotype, levels = CRM46.levels))

## Basal expression
CRM46.bas <- bas.rel %>% filter(Genotype %in% CRM46.levels) %>% 
             select(Genotype, Time, rel_base, Treatment,genotype) %>% 
             mutate(loss_base = 1 - rel_base, Genotype = factor(Genotype, levels = CRM46.levels))



# Information loss relative to WT
## CRM4.6 related Plateau loss
CRM46.plateau %>% 
  filter(!is.na(loss_red), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = loss_red, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(breaks = seq(-0.4,1.0,0.2)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("promoter bashing variants") +
  ylab("Plateau loss \n (Relative to WT)") +
  guides(fill = guide_legend(nrow = 1, title = NULL), pattern = guide_legend(title = NULL)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), 
        legend.position= c(0.02, 0.9),
        axis.title.x=element_blank())
ggsave("output/CRM46_plateau_loss.png", width = 7.2, height = 2)

## plot CRM4.6 related max slope
CRM46.slope %>% 
  filter(!is.na(loss_slope), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = loss_slope, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(breaks = seq(-0.4,1.0,0.2)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("promoter bashing variants") +
  ylab("Max slope loss \n (Relative to WT)") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), 
        legend.position= "none",
        axis.title.x=element_blank())
ggsave("output/CRM46_slope_loss.png", width = 7.2, height = 2)

# CRM4.6 related basal exp
CRM46.bas %>% 
  filter(!is.na(loss_base), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = loss_base, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(breaks = seq(-0.4,1.0,0.2)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("promoter bashing variants") +
  ylab("Basal exp loss \n (Relative to WT)") +
  guides(fill = guide_legend(nrow = 1, title = NULL), pattern = guide_legend(title = NULL)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), 
        legend.position= c(0.02, 0.9),
        axis.title.x=element_blank())
#ggsave("output/CRM46_base_loss.png", width = 10.16, height = 2)



# Relative to WT
## CRM4.6 related Plateau
CRM46.plateau %>% 
  filter(!is.na(rel_red), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = rel_red, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(breaks = seq(-0.4,1.0,0.2)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("promoter bashing variants") +
  ylab("Plateau \n (Relative to WT)") +
  guides(fill = guide_legend(nrow = 1, title = NULL), pattern = guide_legend(title = NULL)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), 
        legend.position= c(0.02, 0.9),
        axis.title.x=element_blank())
#ggsave("output/CRM46_plateau.png", width = 7.2, height = 2)


## plot CRM4.6 related max slope
CRM46.slope %>% 
  filter(!is.na(rel_slope), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = rel_slope, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff")) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none")) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(breaks = seq(-0.4,1.0,0.2)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("promoter bashing variants") +
  ylab("Max slope \n (Relative to WT)") +
  guides(fill = guide_legend(nrow = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), 
        legend.position= "none",
        axis.title.x=element_blank())
#ggsave("output/CRM46_slope.png", width = 7.2, height = 2)

# CRM4.6 related basal exp
CRM46.bas %>% 
  filter(!is.na(rel_base), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = rel_base, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(breaks = seq(-0.4,1.0,0.2)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("promoter bashing variants") +
  ylab("Basal exp \n (Relative to WT)") +
  guides(fill = guide_legend(nrow = 1, title = NULL), pattern = guide_legend(title = NULL)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), 
        legend.position= c(0.02, 0.9),
        axis.title.x=element_blank())
#ggsave("output/CRM46_base.png", width = 10.16, height = 2)

```
# basal exp loss (distal more important thant proximal)
```{r}
distal.levels <- c("WT", "IR_8.10", "IR_6.8", "IR_6.10","IS_2.6","IR_4.6", "IR_2.4", "IS_2.4")

new.bas <- bas.rel %>% filter(Genotype %in% distal.levels) %>% 
  select(Genotype, Time, rel_base, Treatment,genotype) %>% 
  mutate(loss_base = 1 - rel_base, Genotype = factor(Genotype, levels = distal.levels))

new.bas %>% 
  filter(!is.na(loss_base), Genotype != "PC") %>% 
  ggplot(aes(x = Genotype, y = loss_base, fill = Treatment, pattern = Treatment)) + bar.list.no.stat +
 geom_bar_pattern(stat = "summary", fun = "mean",
                   position = position_dodge(preserve = "single"),
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,  # 0.1
                   pattern_spacing = 0.04,  # 0.025
                   pattern_key_scale_factor = 1,
                   width=0.8) + 
  scale_fill_manual(values = c("#b4a7d6ff","#f6b26bff"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  scale_pattern_manual(values = c(`0Pi` = "stripe", `2mMH2O2` = "none"),labels = c("-Pi", bquote(~H[2]*O[2]))) +
  geom_errorbar(stat = "summary", fun.data = mean_cl_boot, width = 0.2, color = "Black", linewidth = 1, position = 
                  position_dodge(width = .9)) +
  scale_y_continuous(limits = c(-0.5, 1.0)) +
  #geom_jitter(width = 0.3) +
  geom_hline(yintercept = 1, col = "gray", linetype = "dashed") +
  xlab("promoter bashing variants") +
  ylab("Basal exp loss \n (Relative to WT)") +
  guides(fill = guide_legend(nrow = 1, title = NULL), pattern = guide_legend(title = NULL)) +
  theme(strip.background = element_rect(colour="black", fill="white", size=1, linetype="solid"), 
        legend.position= c(0.02, 0.9),
        axis.title.x=element_blank())
#ggsave("output/base_loss_distal.png", width = 10.16, height = 2)

```
#define scatter plot settings
```{r}
# Define scatter settings
scatter <- list(
  stat_summary(fun = "mean", geom = "point", size = 3),
  scale_y_continuous(breaks = seq(0, 1.0, 0.25)),
  scale_x_continuous(breaks = seq(0, 800, 200)),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  expand_limits(x = 0, y = 0),
  theme_cowplot(line_size = 0.7, font_size = 20),
  theme(
    legend.position = c(0.65, 0.5),
    legend.text = element_text(face = 3, size = 14), 
    legend.title = element_blank(), # Hide the legend title
    axis.title = element_text(size = rel(1)), 
    axis.text.x = element_text(hjust = 0.5), 
    axis.text = element_text(size = rel(1))
  )
)

```


# plot 3 features vs max distance to core promoter
```{r}
# Basal
distance <- bas.rel %>% select(genotype, Genotype) %>% unique(., by = "genotype") %>% mutate(dis_delta = 200, dis_ave = 200)

distance$dis_delta <- with(distance, ifelse(Genotype == "IS_2.6" | Genotype == "IR_6.10", 400,
                                   ifelse(Genotype == "IS_2.8" | Genotype == "IR_4.10", 600,
                                   ifelse(Genotype == "IS_2.10" | Genotype == "IR_2.10", 800, dis_delta))))

distance$dis_ave <- with(distance, ifelse(Genotype == "IR_2.4" | Genotype == "IS_2.4", 200,
                                   ifelse(Genotype == "IS_2.6" , 300,      
                                   ifelse(Genotype == "IR_4.6" | Genotype == "IS_2.8", 400,
                                   ifelse(Genotype == "IR_2.10"| Genotype == "IS_2.10", 500,    
                                   ifelse(Genotype == "IR_6.8" | Genotype == "IR_4.10", 600,
                                   ifelse(Genotype == "IR_6.10" , 700,
                                   ifelse(Genotype == "IR_8.10" , 800, dis_ave))))))))

dis.base <- bas.rel %>% select(genotype, Genotype, Treatment, rel_base) %>% merge(., distance, by = c("genotype","Genotype"))

# Filter data and create the plot
filtered_data <- dis.base %>% filter(Genotype != "WT")

# set color
treatment_color <- c("#b4a7d6ff","#f6b26bff")

## Calculate the linear model for average length changes
model <- lm(rel_base ~ dis_delta, data = filtered_data)
r_squared <- summary(model)$r.squared
intercept <- coef(model)[1]
slope <- coef(model)[2]

# Create the regression equation as a string
equation <- paste("y = ", round(intercept, 3), " + ", round(slope, 3), "x", sep = "")

# adjust size
scatter <- list(stat_summary(fun = "mean", geom = "point", size = 3),
                scale_y_continuous(breaks = seq(0,1.0,0.25)),
                scale_x_continuous(breaks = seq(0, 800, 200)),
                scale_size_manual(values = c(0.8, 1.5), guide = "none"),
                expand_limits(x = 0, y = 0),
                theme_cowplot(line_size = 0.7, font_size = 20),
                theme(legend.position=c(0.02,0.82),
                legend.text = element_text(face = 3), 
                legend.title = element_text(),
                axis.title = element_text(size = rel(1)), 
                axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1))))

# Create the plot
plot <- filtered_data %>%
  ggplot(aes(x = dis_delta, y = rel_base, color = Treatment)) + scatter +
  geom_point(size = 3) +
  geom_abline(slope = 0, intercept = 1, linetype = "dashed", color = "#666666") +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  scale_color_manual(values = treatment_color) +
  labs(x = "the length of flanking region being changed (bps)", y = "Basal exp \n (relative to WT)") +
  annotate("text", x = max(filtered_data$dis_delta) * 0.6, y = max(filtered_data$rel_base) * 0.9,
           label = paste("R = ", round(r_squared, 2)), size = 5, color = "black") +
  annotate("text", x = max(filtered_data$dis_delta) * 0.6, y = max(filtered_data$rel_base) * 0.8,
           label = equation, size = 5, color = "black")

# Print the plot
print(plot)

# Save the plot
#ggsave("output/base_dis_delta.png", plot = plot, width = 7, height = 7)


## Calculate the linear model for average distance to core promoter
model <- lm(rel_base ~ dis_ave, data = filtered_data)
r_squared <- summary(model)$r.squared
intercept <- coef(model)[1]
slope <- coef(model)[2]

# Create the regression equation as a string
equation <- paste("y = ", round(intercept, 3), " + ", round(slope, 3), "x", sep = "")

# Create the plot
plot <- filtered_data %>%
  ggplot(aes(x = dis_ave, y = rel_base, color = Treatment)) + scatter +
  geom_point(size = 3) +
  geom_abline(slope = 0, intercept = 1, linetype = "dashed", color = "#666666") +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  scale_color_manual(values = treatment_color, labels = c("-Pi", bquote(~H[2]*O[2]))) +
  guides(color = guide_legend(title = NULL)) + 
  labs(x = "Distance to the core promoter (bps)", y = "Basal exp (relative to WT)") +
  annotate("text", x = max(filtered_data$dis_ave) * 0.8, y = max(filtered_data$rel_base) * 0.95,
           label = paste("R = ", round(r_squared, 2)), size = 8, color = "black", hjust = 1, vjust = 1.5)

# Print the plot
print(plot)

# Save the plot
ggsave("output/base_dis_ave.png", plot = plot, width = 4.8, height = 7.6)

```
#Induction relationship to core promoter
#slope
```{r}
dis.slope <- slope.rel %>% select(Genotype, Treatment, rel_slope) %>% merge(., distance, by = c("Genotype"))

# Filter data and create the plot
filtered_data <- dis.slope %>% filter(Genotype != "WT")


## Calculate the linear model for changed length of variants versus slope
model <- lm(rel_slope ~ dis_delta, data = filtered_data)
r_squared <- summary(model)$r.squared
intercept <- coef(model)[1]
slope <- coef(model)[2]

# Create the regression equation as a string
equation <- paste("y = ", round(intercept, 3), " + ", round(slope, 3), "x", sep = "")

# Create the plot
plot <- filtered_data %>%
  ggplot(aes(x = dis_delta, y = rel_slope, color = Treatment)) + scatter +
  geom_point(size = 3) +
  scale_x_continuous(breaks = seq(0, 800, 200)) +
  geom_abline(slope = 0, intercept = 1, linetype = "dashed", color = "#666666") +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  scale_color_manual(values = treatment_color) +
  labs(x = "the length of flanking region being changed (bps)", y = "Basal exp \n (relative to WT)") +
  annotate("text", x = max(filtered_data$dis_delta) * 0.6, y = max(filtered_data$rel_slope) * 0.9,
           label = paste("R = ", round(r_squared, 2)), size = 5, color = "black") +
  annotate("text", x = max(filtered_data$dis_delta) * 0.6, y = max(filtered_data$rel_slope) * 0.8,
           label = equation, size = 5, color = "black")

# Print the plot
print(plot)

# Save the plot
#ggsave("output/slope_dis_delta.png", plot = plot, width = 7, height = 7)


## Calculate the linear model for average distance to core promoter
model <- lm(rel_slope ~ dis_ave, data = filtered_data)
r_squared <- summary(model)$r.squared
intercept <- coef(model)[1]
slope <- coef(model)[2]

# Create the regression equation as a string
equation <- paste("y = ", round(intercept, 3), " + ", round(slope, 3), "x", sep = "")

# Create the plot
plot <- filtered_data %>%
  ggplot(aes(x = dis_ave, y = rel_slope, color = Treatment)) + scatter +
  geom_point(size = 3) +
  scale_x_continuous(breaks = seq(0, 800, 200)) +
  geom_abline(slope = 0, intercept = 1, linetype = "dashed", color = "#666666") +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  scale_color_manual(values = treatment_color, labels = c("-Pi", bquote(~H[2]*O[2]))) +
  guides(color = guide_legend(title = NULL)) +
  labs(x = "Distance to the core promoter (bps)", y = "Maximum slope (relative to WT)") +
  annotate("text", x = max(filtered_data$dis_ave) * 0.8, y = max(filtered_data$rel_slope) * 0.95,
           label = paste("R = ", round(r_squared, 2)), size = 8, color = "black", hjust = 1, vjust = 1.5)



# Print the plot
print(plot)

# Save the plot
ggsave("output/slope_dis_ave.png", plot = plot, width = 4.8, height = 7.6)
```

#Plateau (basal deducted)
```{r}
dis.plateau <- plateau %>% select(genotype, Genotype, Treatment, rel_red) %>% merge(., distance, by = c("Genotype","genotype"))

# Filter data and create the plot
filtered_data <- dis.plateau %>% filter(Genotype != "WT")


## Calculate the linear model for changed length of variants versus slope
model <- lm(rel_red ~ dis_delta, data = filtered_data)
r_squared <- summary(model)$r.squared
intercept <- coef(model)[1]
slope <- coef(model)[2]

# Create the regression equation as a string
equation <- paste("y = ", round(intercept, 3), " + ", round(slope, 3), "x", sep = "")

# Create the plot
plot <- filtered_data %>%
  ggplot(aes(x = dis_delta, y = rel_red, color = Treatment)) + scatter +
  geom_point(size = 3) +
  scale_x_continuous(breaks = seq(0, 800, 200)) +
  geom_abline(slope = 0, intercept = 1, linetype = "dashed", color = "#666666") +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  scale_color_manual(values = treatment_color) +
  labs(x = "the length of flanking region being changed (bps)", y = "Basal exp \n (relative to WT)") +
  annotate("text", x = max(filtered_data$dis_delta) * 0.6, y = max(filtered_data$rel_red) * 0.9,
           label = paste("R = ", round(r_squared, 2)), size = 5, color = "black") +
  annotate("text", x = max(filtered_data$dis_delta) * 0.6, y = max(filtered_data$rel_red) * 0.8,
           label = equation, size = 5, color = "black")

# Print the plot
print(plot)

# Save the plot
#ggsave("output/plateau_dis_delta.png", plot = plot, width = 7, height = 7)


## Calculate the linear model for average distance to core promoter
model <- lm(rel_red ~ dis_ave, data = filtered_data)
r_squared <- summary(model)$r.squared
intercept <- coef(model)[1]
slope <- coef(model)[2]

# Create the regression equation as a string
equation <- paste("y = ", round(intercept, 3), " + ", round(slope, 3), "x", sep = "")

# Create the plot
plot <- filtered_data %>%
  ggplot(aes(x = dis_ave, y = rel_red, color = Treatment)) + scatter +
  geom_point(size = 3) +
  scale_x_continuous(breaks = seq(0, 800, 200)) +
  geom_abline(slope = 0, intercept = 1, linetype = "dashed", color = "#666666") +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  scale_color_manual(values = treatment_color, labels = c("-Pi", bquote(~H[2]*O[2]))) +
  guides(color = guide_legend(title = NULL)) +
  labs(x = "Distance to the core promoter (bps)", y = "Plateau (relative to WT)") +
  annotate("text", x = max(filtered_data$dis_ave) * 0.8, y = max(filtered_data$rel_red) * 0.95,
           label = paste("R = ", round(r_squared, 2)), size = 8, color = "black", hjust = 1, vjust = 1.5)

# Print the plot
print(plot)

# Save the plot
ggsave("output/plateau_dis_ave.png", plot = plot, width = 4.8, height = 7.6)
```

# plot the relationship between basal expression vs induction
```{r}




```


```{r}
##### 2mM H2O2 OL timepoint plot function
tp_GFP <- function(...){
  
  all_tp <- list(...)
  for (input_tp in all_tp) {   
  
    df_tp <- oxi.TrunV.dat %>% filter(new_time == input_tp) %>% mutate(genotype = factor(genotype, levels = levels))
    
    print(ggplot(df_tp, aes(x = genotype, y = new_median, fill = Genotype)) + 
    geom_point() +
    stat_summary(fun.data = "mean_cl_boot", conf.int = .95, color = "Red", linewidth = 1, size = 0.8) +
    labs(x =paste0("2mM H2O2, OL variants ", deparse1(substitute(input_tp)), " min"), y = "Cta1-GFP protein level (a.u.)") +
    theme_cowplot(line_size = 0.7, font_size = 14) +
    theme(legend.position = "none",
          axis.title = element_text(size = rel(1)), 
          axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),))
  }
}

# plot the 2mM H2O2 OL variants at 0min, 90min, 120min timepoints

tp_GFP(0,90,120,240)

```
** Truncation variants**
#### Get the loess curve fitting for the timecourse data
```{r}
# need names colors
genotype_color <- RColorBrewer::brewer.pal(8, "Dark2")[c(8, 7, 6, 1, 5, 4, 2)] 
names(genotype_color) <- names(levels)

# check for the loss fit curve
pi.model <- pi.TrunV.dat  %>%   
group_by(Genotype) %>%
mutate(model = loess(median ~ new_time, span = 0.75, degree = 2)$fitted)

h2o2.model <- oxi.TrunV.dat  %>%   
group_by(Genotype) %>%
mutate(model = loess(median ~ new_time, span = 0.75, degree = 2)$fitted)

pi.model %>% ggplot(aes(x = new_time, y = new_median, color = Genotype)) + mean.timecourse + scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/loess_TrunV_0Pi.png", width = 6.3, height = 8)

h2o2.model %>% ggplot(aes(x = new_time, y = new_median, color = Genotype)) + mean.timecourse + scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
labs(x = "2mM H2O2, Time (min)")
#ggsave("output/loess_TrunV_2mMH2O2.png", width = 6.3, height = 8)


## get AUC for - Pi data into a dataframe
pi.area <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("pi.area", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(genotype_color)) {
# calculate AUC  
madeup.pi <- pi.model %>% filter(Genotype == x) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 
f <- function(x) predict(madeup.pi,newdata=x)
# perform integration
tmp <- integrate(f,0,240)$value
gt_tmp <- x
pi.area[row_cnt,col_cnt] <- tmp
col_cnt = col_cnt + 1
pi.area[row_cnt,col_cnt] <- gt_tmp
col_cnt = 1
row_cnt = row_cnt + 1
}



# get AUC for 2mM H2O2 data
h2o2.area <- data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("h2o2.area", "Genotype"))))
row_cnt = 1
col_cnt = 1
for (x in names(genotype_color)) {
# calculate AUC  
madeup.h2o2 <- h2o2.model %>% filter(Genotype == x) %>% loess(formula = new_median ~ new_time, span = 0.75, degree = 2) 
f <- function(x) predict(madeup.h2o2,newdata=x)
# perform integration
tmp <- integrate(f,0,240)$value
gt_tmp <- x
h2o2.area[row_cnt,col_cnt] <- tmp
col_cnt = col_cnt + 1
h2o2.area[row_cnt,col_cnt] <- gt_tmp
col_cnt = 1
row_cnt = row_cnt + 1
}

# combind area data
area <- merge(pi.area,h2o2.area)
```

#### Check the loess fitting assumption: normality and curve fitting
```{r}

```

### regulatory information map
```{r}
# calculate the relative information retaining within each genotype
reg_info <- area %>% 
  mutate(pi_pcnt = pi.area/(.[.$Genotype == "WT",]$pi.area)) %>% 
  mutate(h2o2_pcnt = h2o2.area/((.[.$Genotype == "WT",]$h2o2.area)))

reg_info %>% 
  ggplot(aes(x = pi_pcnt, y = h2o2_pcnt), color = Genotype) +
  scatter + 
  geom_point(size = 3, aes(color = Genotype)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "#666666") +
  labs(x = "Pi (relative to wt)", y = "H2O2 (relative to wt)") +
  scale_color_manual(values = genotype_color, limits = names(genotype_color))
#ggsave("output/TrunVvswt_0pivsh2o2_scatter.png", width = 6.3, height = 6.3)
```





**test code**
**_1st Differential derivative (Slope) for each curve_**
```{r}
wt.test <- oxi.dat %>% filter(genotype %in% c("wt"))

fit.wt <- loess(new_median~new_time, data=wt.test)

x <- 0:240
px <- predict(fit.wt, newdata = x)
px1 <- diff(px)
#which.max(px1)

wt.loess <- tibble(x = x, y = px)
wt.diff <- tibble (x = x[-1], y = px1)

twoV.test <- oxi.dat %>% filter(genotype %in% c("2V"))

fit.twoV <- loess(new_median~new_time, data=twoV.test)

x <- 0:240
px.2V <- predict(fit.twoV, newdata = x)
px1.2V <- diff(px.2V)

twoV.loess <- tibble(x = x, y = px.2V)
twoV.diff <- tibble (x = x[-1], y = px1.2V)

par(mfrow=c(1, 4))
wt.loess %>% 
ggplot(aes(x = x, y = y)) + geom_point(size = 1, alpha = 0.5) + scale_x_continuous(breaks = seq(0,240,30)) + theme_bw() + ggtitle("loess model")

wt.diff %>% 
  ggplot(aes(x = x, y = y)) + geom_point(size = 1, alpha = 0.5)+ scale_x_continuous(breaks = seq(0, 240, 30)) + theme_bw() + ggtitle("diff(loess model)")


twoV.loess %>% 
ggplot(aes(x = x, y = y)) + geom_point(size = 1, alpha = 0.5) + scale_x_continuous(breaks = seq(0,240,30)) + theme_bw() + ggtitle("loess model")

twoV.diff %>% 
  ggplot(aes(x = x, y = y)) + geom_point(size = 1, alpha = 0.5)+ scale_x_continuous(breaks = seq(0, 240, 30)) + theme_bw() + ggtitle("diff(loess model)")


```
```{r}
fit.wt$


```



**_Statistical test_**

1. Basal level
```{r}
# filter the data and set the basal level
genotype_order <- names(levels)

tmp <- pi.dat %>% 
  filter(new_time == 0, !is.na(new_median)) %>% 
  mutate(Genotype = factor(Genotype, levels = genotype_order))
lm(new_median ~ Genotype, data = tmp) %>% 
  summary()
  #TukeyHSD()
```
2. At 120 minutes
```{r}
tmp <- pi.dat %>% 
  filter(new_time == 120, !is.na(new_median)) %>% 
  mutate(Genotype = factor(Genotype, levels = genotype_order))
lm(new_median ~ Genotype, data = tmp) %>% 
  summary()
```
#### under mock treatment.

Get the subset of Ctrl data
```{r}
ctrl.dat <- data %>% 
  filter(treat == "ctrl", genotype %in% levels) %>%  
  select(Time = Group, Sample, Plate, replicate = Replicate, genotype, median) %>%
  mutate(Genotype = fct_recode(genotype, !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)
```

```{r}
genotype_color <- RColorBrewer::brewer.pal(8, "Dark2")[c(8, 7, 2)] 
names(genotype_color) <- names(levels)

ctrl.dat %>%
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  scale_y_continuous(limits = c(NA, 22))
ggsave("output/20230512-CgSCH9-phosphomimetic-mutant-timecourse-ctrl.png", width = 4.2, height = 4)
```
### Sch9-2E
In _S. cerevisiae_, Pho80/85 was shown to directly phosphorylate Sch9 and thereby regulate its lysosome localization. Here, Jinye interogate a phosphomimetic mutant in _C. glabrata_ and its interaction with _pho80_ and _pho81_ mutants.
```{r}
levels <- c(WT = "wt", `sch9::Sch9-WT-Nat` = "wt_CgSCH9-Nat", `sch9::Sch9-3E-Nat` = "CgSCH9_3E-Nat", `pho80` = "pho80_ko", `pho80 sch9::Sch9-2E` = "pho80_ko_Sch9_2E", `pho81` = "pho81_ko", `pho81 sch9::Sch9-2E` = "pho81_ko_Sch9_2E")

pi.dat.ext <- data %>% 
  filter(treat == "0Pi") %>%  
  select(Time = Group, Sample, Plate, replicate = Replicate, genotype, median) %>%
  mutate(Genotype = fct_recode(genotype,  !!!levels)) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)
```

Plot the time course
```{r}
genotype_color <- RColorBrewer::brewer.pal(8, "Dark2")[c(8, 7, 6, 1, 5, 4, 2)] 
names(genotype_color) <- names(levels)

pi.dat.ext %>%
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_manual(values= genotype_color, limits = names(genotype_color))
#ggsave("output/20230512-CgSCH9-phosphomimetic-mutant-timecourse-noPi.png", width = 4.2, height = 4)
```

> All comparisons except for rom2- vs WT are statistically significant at 0.05 level after Bonferroni correction (threshold: 0.05/5 = 0.01)

