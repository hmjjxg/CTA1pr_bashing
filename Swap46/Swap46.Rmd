---
title: "Swap46 of the CgCTA1pr bashing design"
author: "JY"
date: "2/5/2024"
output: html_document
---
```{r}
library(tidyverse)
library(ggtext)
#library(mgcv)
#library(broom)
library(cowplot)
```

## Common plotting functions
**Update 2022-11-08** 
This list is used as a shared plotting set up.
```{r}
p.timecourse <- list(
  stat_summary(fun = "mean", geom = "point", size = 3),
  stat_summary(fun.data = "mean_cl_boot", geom = "errorbar", width = 3),
  stat_smooth(aes(size = Genotype == "WT"), method = "loess", 
              formula = 'y~x', se = FALSE),
  scale_x_continuous(breaks = seq(0,240,30)),
  scale_size_manual(values = c(0.8, 1.5), guide = "none"),
  labs(x = "Time (min)", y = "Cta1-GFP protein level (a.u.)"),
  theme_cowplot(line_size = 0.7, font_size = 14),
  theme(legend.position=c(0.02,0.9),
        #legend.direction = "horizontal",
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        legend.text = element_text(face = 3), 
        legend.title = element_text(),
        axis.title = element_text(size = rel(1)), 
        #axis.title.x = element_blank(),
        axis.text.x = element_text(hjust=0.5), axis.text = element_text(size = rel(1)),
  )
)
```

## TF deletion mutants compared with wild type
### Prepare data
Import data
```{r}
files <- dir("input/gz_merge", pattern = "merge-*") # get the file names of the merged
files <- file.path("input/gz_merge", files)         # this appends the directory to the file names

names(files) <- c("Rep1-0Pi-H2O2-Ctrl","Rep2-0Pi-H2O2-Ctrl","Rep3-0Pi-H2O2-Ctrl")


tp <- c("0min",  "30min", "60min", "90min", "120min", "150min",  "180min", "210min", "240min") # ordered time points

# import and process the data to the format we want
dat.ord <- map_dfr(files, ~read_csv(., na = c("", "NA", "N/A"), col_types = cols()), .id = "Replicate") %>% 
  filter(Gate == "CTA1-GFP", `X Parameter` == "BL1-H", is.na(`Y Parameter`), Sample != "beads", Count > 100) %>% 
  select(Replicate, Plate, Group, Sample, Count, median = `X Median`, peak = `X Peak`,
         sd = `X SD`, cv = `X %CV`, rCV = `X %rCV`) %>% 
  mutate(Group = ordered(Group, levels = tp)) %>% 
  arrange(Group)

```

Subset the dataset and merge with the genotype information
```{r}
# get genotype info
tr_files <- dir("input/treatment", pattern = "d02*")
tr_files <- file.path("input/treatment", tr_files)
names(tr_files) <- c("Rep1-0Pi-H2O2-Ctrl","Rep2-0Pi-H2O2-Ctrl","Rep3-0Pi-H2O2-Ctrl")


treat.fil <- tr_files %>% 
  map(~read_csv(., na = c("","NA","N/A"), col_types = cols())) %>% 
  bind_rows(.id = "Replicate") %>% 
  filter(!is.na(`group_name`)) %>% 
  select(Replicate, genotype = `group_name`, Sample, treat, HB_strain)


# combine genotype and treat variables into the flow data
data <- left_join(dat.ord, treat.fil, by = c("Replicate", "Sample"))


```

### CTA1 induction during -Pi [Fig. 4A]
Get the subset of no Pi data; get rid of yH298 strain
```{r}
pi.dat <- data %>% 
  filter(treat == "0Pi",HB_strain != "yH298") %>%  # , HB_strain != "yH298"
  select(Time = Group, Sample, Plate, replicate = Replicate, genotype, median, HB_strain) %>%
  mutate(Genotype = fct_recode(genotype, `wt` = "wt", `Swap24_46` = "Swap46_24",  `Swap68_46` = "Swap46_68", `Swap810_46` = "Swap46_810")) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)

h2o2.dat <- data %>% 
  filter(treat == "2mMH2O2", HB_strain != "yH298") %>%  # , HB_strain != "yH298"
  select(Time = Group, Sample, Plate, replicate = Replicate, genotype, median, HB_strain) %>%
  mutate(Genotype = fct_recode(genotype, `wt` = "wt", `Swap24_46` = "Swap46_24",  `Swap68_46` = "Swap46_68", `Swap810_46` = "Swap46_810")) %>%   
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)

ctrl.dat <- data %>% 
  filter(treat == "ctrl", HB_strain != "yH298") %>%  # , HB_strain != "yH298"
  select(Time = Group, Sample, Plate, replicate = Replicate, genotype, median, HB_strain) %>%
  mutate(Genotype = fct_recode(genotype, `wt` = "wt", `Swap24_46` = "Swap46_24",  `Swap68_46` = "Swap46_68", `Swap810_46` = "Swap46_810")) %>% 
  mutate(new_median =median/1000) %>% 
  mutate(new_time = as.numeric(gsub("min","",Time)))%>% 
  arrange(new_time, genotype, replicate)

```



#### Full time course

```{r}
genotype_color <- RColorBrewer::brewer.pal(8, "Dark2")[c(8, 7, 2, 3)] 
#genotype_color <- RColorBrewer::brewer.pal(8, "Dark2")[c(8, 7, 2, 3, 5, 1)] 
names(genotype_color) <- c("wt", "Swap24_46", "Swap68_46", "Swap810_46")

pi.dat %>%
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  labs(x = "Phosphate starvation, Time (min)")
#ggsave("output/swap46_0Pi.png", width = 6.3, height = 6)

h2o2.dat %>%
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  labs(x = "2mM H2O2, Time (min)")
#ggsave("output/swap46_2mMH2O2.png", width = 6.3, height = 6)

ctrl.dat %>%
  filter(!is.na(new_median)) %>% 
  ggplot(aes(x = new_time, y = new_median, color = Genotype)) + p.timecourse +
  scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  labs(x = "Control, Time (min)")
#ggsave("output/swap46_ctrl.png", width = 6.3, height = 6)

```
### Annotation: Below has not been adjusted yet

### Basal vs relative induction levels [Fig. S?]
From the graph above, we can see that the tfâˆ† mutants affected both the basal expression level (at 0 min) and the fold change (relative to the 0'). To further dissect the effects on these two components, we will make some additional plots below
```{r}
genotype_order <- c("WT", "msn2-", "yap1-", "msn4-", "skn7-", "msn4- skn7-")
genotype_color <- RColorBrewer::brewer.pal(8, "Dark2")[c(8, 7, 2, 3, 5, 1)] 
names(genotype_color) <- genotype_order
p.base <- pi.dat %>% 
  filter(new_time == 0, !is.na(new_median)) %>% 
  mutate(Genotype = factor(Genotype, levels = genotype_order)) %>% 
  ggplot(aes(x = Genotype, y = new_median)) +
  geom_point(position = position_jitter(width = 0.1), alpha = 0.5, shape = 16) +
  stat_summary(aes(color = Genotype), fun.data = "mean_cl_boot", geom = "errorbar",
               width = 0.3, linewidth = 1.2) +
  stat_summary(aes(color = Genotype), fun = "mean", geom = "point", size = 4) +
  scale_color_manual(values = genotype_color, guide = "none") +
  labs(y = "Cta1-GFP protein level (a.u.)") +
  theme_cowplot(line_size = 0.7, font_size = 14) +
  background_grid() + panel_border(color = "black", size = 1.5) +
  theme(#legend.position=c(0.05,0.75), 
        #legend.box.background = element_rect(color = "black"),
        #legend.box.margin = margin(3,3,3,3),
        #legend.text = element_text(face = 3), 
        #legend.title = element_text(),
    axis.line = element_blank(),
    axis.title = element_text(size = rel(1)), 
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), axis.text = element_text(size = rel(1)),
  )

p.base
```

Statistical test
```{r}
# filter the data and set the basal level
tmp <- pi.dat %>% 
  filter(new_time == 0, !is.na(new_median)) %>% 
  mutate(Genotype = factor(Genotype, levels = genotype_order))
lm(new_median ~ Genotype, data = tmp) %>% 
  summary()
  #TukeyHSD()
```
> All comparisons except for msn2- vs WT are statistically significant at 0.05 level after Bonferroni correction (threshold: 0.05/5 = 0.01)

```{r}
# subtract 0 min mean from all time points for each genotype
p.induce <- pi.dat %>% 
  filter(!is.na(new_median)) %>% 
  group_by(Genotype) %>% 
  mutate(delta = new_median - mean(new_median[new_time == 0])) %>% 
  ggplot(aes(x = new_time, y = delta, color = Genotype)) + p.timecourse +
  scale_color_manual(values= genotype_color, limits = names(genotype_color)) +
  scale_x_continuous(breaks = seq(0, 240, by = 30), labels = c(0, '', 60, '', 120, '', 180, '', 240))

plot_grid(p.base, NULL, p.induce, nrow = 1, rel_widths = c(1.5, 0.1, 1.5), align = "hv")
#ggsave("output/20221117-Pi-H2O2-timecourse.png", width = 4, height = 3.5)
ggsave("output/20221221-CTA1-trans-delete-base-vs-induce.png", width = 10, height = 5)
```

To test for the effect on induction, we can compare the levels at 120 min
```{r}
pi.dat %>% 
  filter(!is.na(new_median)) %>% 
  group_by(Genotype) %>% 
  mutate(delta = new_median - mean(new_median[new_time == 0])) %>% 
  filter(new_time == 120, !is.na(new_median)) %>% 
  mutate(Genotype = factor(Genotype, levels = genotype_order)) %>% 
  lm(delta ~ Genotype, data = .) %>% 
  summary()
```




```{r}


```